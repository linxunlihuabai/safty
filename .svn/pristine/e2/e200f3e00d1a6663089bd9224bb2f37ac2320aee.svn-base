<template>
  <div class="dashboard-container">
    <div class="panel">
      <div class="panel-title">
        <breadcrumb class="breadcrumb-container" />
      </div>
      <!-- 搜索框的按钮哟 -->
      <el-tabs v-model="activeName">
        <el-tab-pane label="企业基本信息" name="first">
          <el-row>
            <el-col :span="24">
              <el-form :inline="true" :model="params" class="demo-form-inline">
                <el-form-item label="企业名称" prop="enterpriseId">
                  <el-cascader
                    v-model="params.enterpriseIds"
                    style="width: 100%"
                    size="small"
                    placeholder="请选择企业"
                    :options="enterpriseOptions"
                    :props="{ checkStrictly: true }"
                    clearable
                  />
                </el-form-item>
                <el-form-item>
                  <el-input
                    v-model="params.enterpriseName"
                    placeholder="单位名称"
                    style="width:180px;"
                    size="small"
                  />
                </el-form-item>
                <el-form-item>
                  <el-button type="primary" icon="el-icon-search" size="small" @click="fetchData">查询</el-button>
                </el-form-item>
              </el-form>
            </el-col>
          </el-row>
          <el-button type="primary" size="small" @click="addEnterpriseDialog=true;locData.lng=0;locData.lat=0">
            <i class="el-icon-plus" /> 新增
          </el-button>
          <el-table v-loading="pageEnterpriseLoading" border :data="page.list" size="small" stripe :expand-row-keys="expands" :row-key="getRowKeys" empty-text="空" @expand-change="expandSelect">
            <!-- 详情展示 -->
            <el-table-column type="expand">
              <template slot-scope="props">
                <el-form class="demo-table-expand">
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="企业名称：">
                        <span>{{ props.row.enterpriseName }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="代码证类型：">
                        <span>{{ props.row.certificateType }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="单位类别：">
                        <span>{{ props.row.unitCategory }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="注册地址：">
                        <span>{{ props.row.registerAddress }}</span>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="统一社会信用代码：">
                        <span>{{ props.row.creditCode }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="生产经营地址：">

                        <span>{{ props.row.businessAddress }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="营业执照类别：">
                        <span>{{ props.row.businessLicenseCategory }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="法定代表人：">
                        <span>{{ props.row.legalRepresentative }}</span>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="法定代表人联系电话：">
                        <span>{{ props.row.contactNumber }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="经营范围：">
                        <span>{{ props.row.businessScope }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="行业类别：">
                        <span>{{ props.row.industryCategory }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="工商登记有效期：">
                        <el-tag size="small">{{ props.row.registerValidityStartTime| dateFormat('YYYY年MM月DD日') }}</el-tag>
                        <el-tag size="small" type="success">{{ props.row.registerValidityEndTime| dateFormat('YYYY年MM月DD日') }}</el-tag>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="企业规模：">
                        <span>{{ props.row.scale }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="经济类型：">
                        <span>{{ props.row.economicType }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="父级单位：">
                        <span>{{ props.row.parentName }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="在岗员工数：">
                        <span>{{ props.row.onDutyEmployeeNumber }}</span>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="12" class="colBorder">
                      <el-form-item label="注册证件上传：">
                        <el-image v-for="item in props.row.registerCertificates" :key="item.id" :src="'http://192.168.100.2:8080' + item.url" style="width:150px; height: 150px">
                          {{ 'http://192.168.100.2:8080' + item.url }}
                        </el-image>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="外用工人数：">
                        <span>{{ props.row.externalWorkerNumber }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6">
                      <el-form-item label="企业状态">
                        <span>{{ props.row.state }}</span>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="12">
                      <el-form-item label="办公地点GPS坐标：">
                        <baidu-map
                          :center="props.row.projectGPSCoordinates"
                          :zoom="zoom"
                          style="float:left; width: 400px; height: 280px"
                          :scroll-wheel-zoom="true"
                          @ready="smallEnterpriseMap"
                        />
                      </el-form-item>
                    </el-col>
                  </el-row>
                </el-form>
              </template>
            </el-table-column>
            <el-table-column sortable prop="enterpriseName" label="企业名称" />
            <el-table-column sortable prop="legalRepresentative" label="法定代表人" />
            <el-table-column sortable prop="contactNumber" label="联系电话" />
            <el-table-column sortable prop="parentName" label="父级单位" />
            <el-table-column label="操作">
              <template slot-scope="scope">
                {{ setCurrentIndex(scope.$index) }}
                <el-button
                  type="text"
                  size="small"
                  @click="editOpenEnterpriseDialog(scope.$index,scope.row)"
                >编辑</el-button>
                <el-button type="text" size="small" @click="delEnterprise(scope.$index,scope.row)">删除</el-button>
              </template>
            </el-table-column>
          </el-table>
          <!-- 分页栏 -->
          <el-row>
            <!-- 分页栏 -->
            <el-pagination
              class="pagination"
              layout="total, sizes, prev, pager, next, jumper"
              :current-page="page.page"
              :total="page.total"
              :page-sizes="[10, 20, 50, 100]"
              @size-change="handleSizeChangeEnterprise"
              @current-change="handleCurrentChangeEnterprise"
            />
          </el-row>
        </el-tab-pane>
        <el-tab-pane label="安全生产信息" name="second">
          <el-button type="primary" size="small" @click="addSafeDialog=true">
            <i class="el-icon-plus" /> 新增
          </el-button>
          <el-table v-loading="pageSafeLoading" :data="pageSafe.list" size="small" border style="width: 100%">
            <el-table-column type="expand">
              <template slot-scope="props">
                <el-form class="demo-table-expand">
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="企业名称：">
                        <span>{{ props.row.enterpriseName }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="安全生产主要负责人：">
                        <span>{{ props.row.safetyProductionMainResponsiblePerson }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="从业人数：">
                        <span>{{ props.row.employeeNumber }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="安全生产主要负责人联系电话：">
                        <span>{{ props.row.safetyProductionMainResponsiblePersonContactNumber }}</span>
                      </el-form-item>
                    </el-col>

                  </el-row>
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="注册安全工程师人数：">
                        <span>{{ props.row.registerSafeEngineerNumber }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="分管安全负责人：">
                        <span>{{ props.row.inChargeOfSafety }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="特种作业人数：">
                        <span>{{ props.row.specialWorkNumber }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="分管安全负责人电话：">
                        <span>{{ props.row.inChargeOfSecurityResponsiblePersonTelephone }}</span>
                      </el-form-item>
                    </el-col>

                  </el-row>
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="专职安全管理人员：">
                        <span>{{ props.row.safetyManagementPersonnel }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="安全生产许可证有效期：">
                        <span>{{ props.row.registerValidity }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="专职安全管理人员电话：">
                        <span>{{ props.row.safetyManagementPersonnelTelephone }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="工商登记有效期：">
                        <el-tag size="small">{{ props.row.productionLicenseValidityStartTime| dateFormat('YYYY年MM月DD日') }}</el-tag>
                        <el-tag size="small" type="success">{{ props.row.productionLicenseValidityEndTime| dateFormat('YYYY年MM月DD日') }}</el-tag>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="单位值班电话：">
                        <span>{{ props.row.unitOnDutyPhone }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="电子邮箱：">
                        <span>{{ props.row.email }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="父级单位：">
                        <span>{{ props.row.parentName }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="生产状态：">
                        <span>{{ props.row.productionState }}</span>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="12" class="colBorder">
                      <el-form-item label="许可证扫描件上传：">
                        <el-image :src="props.row.licenseScanFiles" />
                      </el-form-item>
                    </el-col>
                    <el-col :span="12" class="colBorder">
                      <el-form-item label="安全机构设置：">
                        <el-image :src="props.row.safeOrganizationSetting" />
                      </el-form-item>
                    </el-col>
                  </el-row>
                </el-form>
              </template>
            </el-table-column>
            <el-table-column prop="safetyProductionMainResponsiblePerson" label="安全生产主要负责人" />
            <el-table-column prop="safetyProductionMainResponsiblePersonContactNumber" label="安全生产主要负责人联系电话" />
            <el-table-column prop="unitOnDutyPhone" label="单位值班电话" />
            <el-table-column sortable prop="parentName" label="父级单位" />
            <el-table-column label="操作">
              <template slot-scope="scope">
                <el-button
                  type="text"
                  size="small"
                  @click="editOpenSafeDialog(scope.$index,scope.row)"
                >编辑</el-button>
                <el-button type="text" size="small">删除</el-button>
              </template>
            </el-table-column>

            <!-- 分页栏 -->
            <el-row>
              <!-- 分页栏 -->
              <el-pagination
                class="pagination"
                layout="total, sizes, prev, pager, next, jumper"
                :current-page="page.page"
                :total="page.total"
                :page-sizes="[10, 20, 50, 100]"
                @size-change="handleSizeChangeSafe"
                @current-change="handleSizeChangeSafe"
              />
            </el-row>
          </el-table>
        </el-tab-pane>
      </el-tabs>
      <!-- 企业基本信息-修改 -->
      <el-dialog title="企业基本信息-修改" :visible.sync="editEnterpriseDialog" width="1200px">
        <el-form ref="editEnterpriseData" :rules="enterpriseRules" size="small" :model="editEnterpriseData" label-width="150px">
          <el-row>
            <el-col :span="6" class="colBorder" style="background-color:#F6F6F8;">
              <el-form-item label="企业名称" label-width="78px" prop="enterpriseId">
                <el-cascader
                  v-model="editEnterpriseData.enterpriseIds"
                  style="width: 100%"
                  size="small"
                  placeholder="请选择企业"
                  :options="enterpriseOptions"
                  :props="{ checkStrictly: true }"
                  clearable
                  @change="handleEditEnterpriseChange"
                />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="代码证类型" prop="certificateType" label-width="94px">
                <el-input v-model="editEnterpriseData.certificateType" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="单位类别" label-width="78px" prop="unitCategory">
                <el-input v-model="editEnterpriseData.unitCategory" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="注册地址" prop="registerAddress" label-width="78px">
                <el-input v-model="editEnterpriseData.registerAddress" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder">
              <el-form-item label="统一社会信用代码" prop="creditCode" label-width="135px">
                <el-input v-model="editEnterpriseData.creditCode" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="生产经营地址" prop="businessAddress" label-width="108px">
                <el-input v-model="editEnterpriseData.businessAddress" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="营业执照类别" prop="businessLicenseCategory" label-width="108px">
                <el-input v-model="editEnterpriseData.businessLicenseCategory" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="法定代表人" prop="legalRepresentative" label-width="94px">
                <el-input v-model="editEnterpriseData.legalRepresentative" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder">
              <el-form-item label="法定代表人联系电话" prop="contactNumber" label-width="148px" required>
                <el-input v-model="editEnterpriseData.contactNumber" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="经营范围" prop="businessScope" label-width="78px">
                <el-input v-model="editEnterpriseData.businessScope" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="行业类别" prop="industryCategory" label-width="78px">
                <el-input v-model="editEnterpriseData.industryCategory" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="外用工人数" prop="externalWorkerNumber" label-width="92px" required>
                <el-input-number v-model="editEnterpriseData.externalWorkerNumber" :min="0" :max="1000" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder">
              <el-form-item label="企业规模" prop="scale" label-width="78px">
                <el-input v-model="editEnterpriseData.scale" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="经济类型" prop="economicType" label-width="78px">
                <el-input v-model="editEnterpriseData.economicType" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="在岗员工数" prop="onDutyEmployeeNumber" label-width="92px" required>
                <el-input-number v-model="editEnterpriseData.onDutyEmployeeNumber" :min="0" :max="1000" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder">
              <el-form-item label="企业状态" prop="state" label-width="78px">
                <el-input v-model="editEnterpriseData.state" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="工商登记有效期" prop="registerValidityEndTime" label-width="120px">
                <el-date-picker
                  v-model="registerValidity"
                  type="daterange"
                  range-separator="至"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
                  value-format="yyyy-MM-dd"
                  @change="editEnterpriseChangeData"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col>
              <el-form-item label="注册证件" prop="registerCertificates">
                <el-upload
                  list-type="picture-card"
                  :on-success="handleEditSuccess"
                  :on-preview="handlePictureCardPreview"
                  :on-remove="handleEditRemove"
                  :before-upload="beforeAvatarUpload"
                  :file-list="editEnterpriseData.registerCertificates"
                  :data="GLOBAL.FILE_TYPE.RULES"
                  action="/api/ajax/upload"
                  @error="handleLoadError"
                >
                  <i class="el-icon-upload" />
                  <span style="color: #606266;">点击上传</span>
                </el-upload>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="24">
              <el-form-item label="办公地点GPS坐标">
                <el-input v-model="locData.lng" style="width:150px;" />
                <el-input v-model="locData.lat" style="width:150px;" />
                <baidu-map
                  :center="editEnterpriseData.projectGPSCoordinates"
                  :zoom="zoom"
                  style="width: 100%; height: 280px"
                  ak="sCrmUchPh7eKuHSyuZKx0e1acqyk7REF"
                  :scroll-wheel-zoom="true"
                  @ready="editEnterpriseDialogMap"
                  @click="getEditEnterpriseClickInfoMap"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item>
            <el-button :loading="btnLoading" type="primary" @click="submitEnterpriseEditForm('editEnterpriseData')">确定</el-button>
            <el-button @click="editEnterpriseDialog = false">取消</el-button>
          </el-form-item>
        </el-form>
      </el-dialog>
      <!-- 企业基本信息-新增 -->
      <el-dialog title="企业基本信息-新增" :visible.sync="addEnterpriseDialog" width="72%" :before-close="handleClose">
      <el-dialog title="企业基本信息-新增" :visible.sync="addEnterpriseDialog" width="1200px">
        <el-form
          id="addEnterpriseData"
          ref="addEnterpriseData"
          size="small"
          :model="addEnterpriseData"
          :rules="enterpriseRules"
        >
          <el-row>
            <el-col :span="6" class="colBorder2" style="background-color:#F6F6F8;">
              <el-form-item label="企业名称" required label-width="78px" prop="enterpriseIds">
            <el-col :span="6" class="colBorder">
              <el-form-item label="企业名称" required label-width="78px" prop="enterpriseId">
                <el-cascader
                  v-model="addEnterpriseData.enterpriseIds"
                  style="width: 100%"
                  size="small"
                  placeholder="请选择企业"
                  :options="enterpriseOptions"
                  :props="{ checkStrictly: true }"
                  clearable
                  @change="handleAddEnterpriseChange"
                />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="代码证类型" prop="certificateType" label-width="94px">
                <el-input v-model="addEnterpriseData.certificateType" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder2">
            <el-col :span="6" class="colBorder">
              <el-form-item label="单位类别" label-width="78px" prop="unitCategory">
                <el-input v-model="addEnterpriseData.unitCategory" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="注册地址" prop="registerAddress" label-width="78px">
                <el-input v-model="addEnterpriseData.registerAddress" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder2">
            <el-col :span="6" class="colBorder">
              <el-form-item label="统一社会信用代码" prop="creditCode" label-width="135px">
                <el-input v-model="addEnterpriseData.creditCode" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="生产经营地址" prop="businessAddress" label-width="108px">
                <el-input v-model="addEnterpriseData.businessAddress" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder2">
            <el-col :span="6" class="colBorder">
              <el-form-item label="营业执照类别" prop="businessLicenseCategory" label-width="108px">
                <el-input v-model="addEnterpriseData.businessLicenseCategory" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="法定代表人" prop="legalRepresentative" label-width="94px">
                <el-input v-model="addEnterpriseData.legalRepresentative" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder2">
            <el-col :span="6" class="colBorder">
              <el-form-item label="法定代表人联系电话" prop="contactNumber" label-width="148px" required>
                <el-input v-model="addEnterpriseData.contactNumber" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="经营范围" prop="businessScope" label-width="78px">
                <el-input v-model="addEnterpriseData.businessScope" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder2">
            <el-col :span="6" class="colBorder">
              <el-form-item label="行业类别" prop="industryCategory" label-width="78px">
                <el-input v-model="addEnterpriseData.industryCategory" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="外用工人数" prop="externalWorkerNumber" label-width="92px">
                <el-input-number v-model="addEnterpriseData.externalWorkerNumber" :min="1" :max="1000" />
              <el-form-item label="外用工人数" prop="externalWorkerNumber" label-width="92px" required>
                <el-input-number v-model="addEnterpriseData.externalWorkerNumber" :min="0" :max="1000" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder2">
            <el-col :span="6" class="colBorder">
              <el-form-item label="企业规模" prop="scale" label-width="78px">
                <el-input v-model="addEnterpriseData.scale" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="经济类型" prop="economicType" label-width="78px">
                <el-input v-model="addEnterpriseData.economicType" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="上级单位" prop="parentName" label-width="78px">
                <el-input v-model="addEnterpriseData.parentName" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="在岗员工数" prop="onDutyemployeeNumber" label-width="92px">
                <el-input-number v-model="addEnterpriseData.onDutyemployeeNumber" :min="1" :max="1000" />
              <el-form-item label="在岗员工数" prop="onDutyemployeeNumber" label-width="92px" required>
                <el-input-number v-model="addEnterpriseData.onDutyemployeeNumber" :min="0" :max="1000" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder2">
            <el-col :span="6" class="colBorder">
              <el-form-item label="企业状态" prop="state" label-width="78px">
                <el-input v-model="addEnterpriseData.state" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="工商登记有效期" prop="registerValidity" label-width="120px">
                <el-date-picker
                  v-model="addEnterpriseData.registerValidity"
                  type="daterange"
                  align="right"
                  unlink-panel
                  range-separator="至"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
                  value-format="yyyy-MM-dd"
                  @change="addEnterpriseChangeData"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="24">
              <el-form-item label="注册证件" prop="registerCertificates">
                <el-upload
                  v-model="addEnterpriseData.registerCertificates"
                  :on-success="handleAddSuccess"
                  action="/api/ajax/upload"
                  :on-preview="handlePictureCardPreview"
                  :on-remove="handleAddRemove"
                  :before-upload="beforeAvatarUpload"
                  :data="GLOBAL.FILE_TYPE.RULES"
                  list-type="picture-card"
                  @error="handleLoadError"
                >
                  <i class="el-icon-upload" />
                  <span style="color: #606266;">点击上传</span>
                </el-upload>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="24">
              <el-form-item label="办公地点GPS坐标" required>
                <el-row>
                  <el-col :span="8">
                    <el-row>
                      <el-col :span="12">
                        <el-input v-model="locData.lng" placeholder="坐标经度" />
                      </el-col>
                      <el-col :span="12">
                        <el-input v-model="locData.lat" placeholder="坐标纬度" style="padding-left:10px;" />
                      </el-col>
                    </el-row>
                  </el-col>
                </el-row>
                <baidu-map
                  :center="addEnterpriseData.projectGPSCoordinates"
                  :zoom="zoom"
                  style="float:left; width: 100%; height: 280px"
                  ak="sCrmUchPh7eKuHSyuZKx0e1acqyk7REF"
                  :scroll-wheel-zoom="true"
                  @ready="addEnterpriseDialogMap"
                  @click="getAddEnterpriseClickInfoMap"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-form-item>
              <el-button :loading="btnLoading" type="primary" @click="submitEnterpriseAddForm('addEnterpriseData')">确定</el-button>
              <el-button @click="addEnterpriseDialog = false">取消</el-button>
            </el-form-item>
          </el-row>
        </el-form>
      </el-dialog>

      <!-- 安全生产信息的修改 -->
      <el-dialog title="安全生产信息-修改" :visible.sync="editSafeDialog" width="60%" :before-close="handleClose">
      <el-dialog title="安全生产信息-修改" :visible.sync="editSafeDialog" width="990px">
        <el-form ref="editSafeData" :rules="rulesSafe" size="small" :model="editSafeData" label-width="150px">
          <el-row>
            <el-col :span="6" class="colBorder">
              <el-form-item label="企业名称" label-width="78px" prop="enterpriseIds">
              <el-form-item label="企业名称" label-width="78px" prop="enterpriseId">
                <el-cascader
                  v-model="editEnterpriseData.enterpriseIds"
                  disabled
                  style="width: 100%"
                  size="small"
                  placeholder="请选择企业"
                  :options="enterpriseOptions"
                  :props="{ checkStrictly: true }"
                  clearable
                  @change="handleEditSafeChange"
                />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="邮箱" prop="email" label-width="78px">
              <el-form-item label="邮箱" prop="email" label-width="50px">
                <el-input v-model="editSafeData.email" disabled />
              </el-form-item>
            </el-col>

            <el-col :span="6" class="colBorder">
              <el-form-item label="从业人数" prop="employeeNumber" required label-width="78px">
                <el-input-number v-model="editSafeData.employeeNumber" :min="1" :max="2000" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="分管安全负责人" prop="inChargeOfSafety" label-width="120px">
                <el-input v-model="editSafeData.inChargeOfSafety" disabled />
              </el-form-item>
            </el-col>

          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder">
            <el-col :span="7" class="colBorder">
              <el-form-item label="单位值班电话" prop="unitOnDutyPhone" label-width="106px">
                <el-input v-model="editSafeData.unitOnDutyPhone" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="父级单位" prop="parentName" label-width="78px">
                <el-input v-model="editSafeData.parentName" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
            <el-col :span="7" class="colBorder">
              <el-form-item label="特种作业人数" prop="specialWorkNumber" label-width="106px">
                <el-input-number v-model="editSafeData.specialWorkNumber" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
            <el-col :span="6">
              <el-form-item label="生产状态" prop="productionState" label-width="78px">
                <el-input v-model="editSafeData.productionState" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="10">
              <el-form-item label="注册证件" prop="RegistrationDocumentUpload" label-width="78px">
                <el-upload
                  v-model="editSafeData.RegistrationDocumentUpload"
                  action="https://jsonplaceholder.typicode.com/posts/"
                  :file-list="registerCertificates"
                  list-type="picture-card"
                  :on-preview="handlePictureCardPreview"
                  :on-remove="handleSafeEditRemove"
                  :on-remove="handleEditSafeRemove"
                  @error="handleLoadError"
                >
                  <i class="el-icon-plus" />
                </el-upload>
              </el-form-item>
            </el-col>
            <el-col :span="14">
              <el-form-item label="安全机构设置" prop="safeOrganizationSetting" label-width="106px">
                <el-upload
                  ref="upload"
                  :data="GLOBAL.FILE_TYPE.QUALIFICATION"
                  name="file"
                  class="upload-demo"
                  drag
                  action="https://jsonplaceholder.typicode.com/posts/"
                  action="/api/ajax/upload"
                  multiple
                  :on-progress="handleEditSafeProgress"
                  :on-error="handleEditSafeError"
                  :on-success="handleEditSafeSuccess"
                  :on-preview="handleEditSafePreview"
                  :on-remove="handleEditSafeRemove"
                  :file-list="editSafeData.safeOrganizationSetting"
                >
                  <i class="el-icon-upload" />
                  <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                  <div slot="tip" class="el-upload__tip">只能上传jpg/png文件，且不超过500kb</div>
                </el-upload>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="8" class="colBorder">
              <el-form-item label="注册安全工程师人数" prop="registerSafeEngineerNumber" label-width="148px">
                <el-input-number v-model="editSafeData.registerSafeEngineerNumber" size="small" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="专职安全管理人员" prop="safetyManagementPersonnel" label-width="136px">
                <el-input v-model="editSafeData.safetyManagementPersonnel" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="分管安全负责人电话" prop="inChargeOfSecurityResponsiblePersonTelephone" label-width="148px">
                <el-input v-model="editSafeData.inChargeOfSecurityResponsiblePersonTelephone" disabled />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="9" class="colBorder">
              <el-form-item label="专职安全管理人员电话" prop="safetyManagementPersonnelTelephone" label-width="168px">
                <el-input v-model="editSafeData.safetyManagementPersonnelTelephone" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="安全生产主要负责人" prop="safetyProductionMainResponsiblePerson" label-width="148px">
                <el-input v-model="editSafeData.safetyProductionMainResponsiblePerson" disabled />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="10" class="colBorder">
              <el-form-item label="安全生产主要负责人联系电话" prop="safetyProductionMainResponsiblePersonContactNumber" required label-width="210px">
                <el-input v-model="editSafeData.safetyProductionMainResponsiblePersonContactNumber" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="9" class="colBorder">
              <el-form-item label="专职安全管理人员人数" prop="safeManageEmployeeNumber" label-width="160px">
                <el-input-number v-model="editSafeData.safeManageEmployeeNumber" size="small" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="13" class="colBorder">
              <el-form-item label="工商登记有效期" prop="productionLicenseValidity" label-width="162px">
                <el-date-picker
                  v-model="editSafeData.productionLicenseValidity"
                  v-model="productionLicenseValidity"
                  type="daterange"
                  align="right"
                  range-separator="至"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
                  value-format="yyyy-MM-dd"
                  @change="editSafeChangeData"
                />
              </el-form-item>
            </el-col>
            <el-col :span="13" class="colBorder">
              <el-form-item label="安全生产有效期" prop="registerValidity" label-width="162px">
                <el-date-picker
                  v-model="editSafeData.registerValidity"
                  v-model="registerValidity"
                  disabled
                  type="daterange"
                  align="right"
                  range-separator="至"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
                  @change="editSafeChangeData"
                />
              </el-form-item>
            </el-col>
          </el-row>
         

          <el-form-item>
            <el-button :loading="btnLoading" type="primary">确定</el-button>
            <el-button @click="editSafeDialog = false">取消</el-button>
          </el-form-item>
        </el-form>
      </el-dialog>
      <el-dialog title="安全生产信息-新增" :visible.sync="addSafeDialog" width="60%" :before-close="handleClose">
      <el-dialog title="安全生产信息-新增" :visible.sync="addSafeDialog" width="990px">
        <el-form
          ref="addSafeData"
          size="small"
          :model="addSafeData"
          :rules="rulesSafe"
          label-width="150px"
        >
          <el-row>
            <el-col :span="6" class="colBorder">
              <el-form-item label="企业名称" label-width="78px" prop="enterpriseIds">
              <el-form-item label="企业名称" label-width="78px" prop="enterpriseId">
                <el-cascader
                  v-model="addSafeData.enterpriseIds"
                  style="width: 100%"
                  size="small"
                  placeholder="请选择企业"
                  :options="enterpriseOptions"
                  :props="{ checkStrictly: true }"
                  clearable
                  @change="handleAddSafeChange"
                  @change="handleEditSafeChange"
                />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="邮箱" prop="email" label-width="78px">
              <el-form-item label="邮箱" prop="email" label-width="50px">
                <el-input v-model="addSafeData.email" disabled />
              </el-form-item>
            </el-col>

            <el-col :span="6" class="colBorder">
              <el-form-item label="从业人数" prop="employeeNumber" required label-width="78px">
                <el-input-number v-model="addSafeData.employeeNumber" :min="1" :max="2000" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="分管安全负责人" prop="inChargeOfSafety" label-width="120px">
                <el-input v-model="addSafeData.inChargeOfSafety" disabled />
              </el-form-item>
            </el-col>

          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder">
              <el-form-item label="单位值班电话" prop="unitOnDutyPhone" label-width="106px">
                <el-input v-model="addSafeData.unitOnDutyPhone" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="父级单位" prop="parentName" label-width="78px">
                <el-input v-model="addSafeData.parentName" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="特种作业人数" prop="specialWorkNumber" label-width="106px">
                <el-input-number v-model="addSafeData.specialWorkNumber" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
            <el-col :span="6">
              <el-form-item label="生产状态" prop="productionState" label-width="78px">
                <el-input v-model="addSafeData.productionState" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="10">
              <el-form-item label="注册证件" prop="RegistrationDocumentUpload" label-width="78px">
                <el-upload
                  v-model="addSafeData.RegistrationDocumentUpload"
                  action="https://jsonplaceholder.typicode.com/posts/"
                  :file-list="registerCertificates"
                  list-type="picture-card"
                  :on-preview="handlePictureCardPreview"
                  :on-remove="handleSafeEditRemove"
                  :on-remove="handleAddSafeRemove"
                  @error="handleLoadError"
                >
                  <i class="el-icon-plus" />
                </el-upload>
              </el-form-item>
            </el-col>
            <el-col :span="14">
              <el-form-item label="安全机构设置" prop="safeOrganizationSetting" label-width="106px">
                <el-upload
                  class="upload-demo"
                  drag
                  action="https://jsonplaceholder.typicode.com/posts/"
                  multiple
                >
                  <i class="el-icon-upload" />
                  <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                  <div slot="tip" class="el-upload__tip">只能上传jpg/png文件，且不超过500kb</div>
                </el-upload>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="8" class="colBorder">
              <el-form-item label="注册安全工程师人数" prop="registerSafeEngineerNumber" label-width="148px">
                <el-input-number v-model="addSafeData.registerSafeEngineerNumber" size="small" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="专职安全管理人员" prop="safetyManagementPersonnel" label-width="136px">
                <el-input v-model="addSafeData.safetyManagementPersonnel" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="分管安全负责人电话" prop="inChargeOfSecurityResponsiblePersonTelephone" label-width="148px">
                <el-input v-model="addSafeData.inChargeOfSecurityResponsiblePersonTelephone" disabled />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" class="colBorder">
              <el-form-item label="安全生产许可证有效期" prop="productionLicenseValidity" label-width="162px">
            <el-col :span="9" class="colBorder">
              <el-form-item label="专职安全管理人员电话" prop="safetyManagementPersonnelTelephone" label-width="168px">
                <el-input v-model="addSafeData.safetyManagementPersonnelTelephone" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="安全生产主要负责人" prop="safetyProductionMainResponsiblePerson" label-width="148px">
                <el-input v-model="addSafeData.safetyProductionMainResponsiblePerson" disabled />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="10" class="colBorder">
              <el-form-item label="安全生产主要负责人联系电话" prop="safetyProductionMainResponsiblePersonContactNumber" required label-width="210px">
                <el-input v-model="addSafeData.safetyProductionMainResponsiblePersonContactNumber" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="9" class="colBorder">
              <el-form-item label="专职安全管理人员人数" prop="safeManageEmployeeNumber" label-width="160px">
                <el-input-number v-model="addSafeData.safeManageEmployeeNumber" size="small" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="13" class="colBorder">
              <el-form-item label="工商登记有效期" prop="productionLicenseValidity" label-width="162px">
                <el-date-picker
                  v-model="addSafeData.productionLicenseValidity"
                  type="daterange"
                  align="right"
                  range-separator="至"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
                  value-format="yyyy-MM-dd"
                  @change="addSafeChangeData"
                />
              </el-form-item>
            </el-col>
            <el-col :span="12" class="colBorder">
            <el-col :span="13" class="colBorder">
              <el-form-item label="安全生产有效期" prop="registerValidity" label-width="162px">
                <el-date-picker
                  v-model="addSafeData.registerValidity"
                  type="daterange"
                  align="right"
                  range-separator="至"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
                  @change="addSafeChangeData"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="8" class="colBorder">
              <el-form-item label="专职安全管理人员人数" prop="safeManageEmployeeNumber" label-width="160px">
                <el-input-number v-model="addSafeData.safeManageEmployeeNumber" size="small" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="安全生产主要负责人联系电话" prop="safetyProductionMainResponsiblePersonContactNumber" required label-width="160px">
                <el-input v-model="addSafeData.safetyProductionMainResponsiblePersonContactNumber" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="专职安全管理人员电话" prop="safetyManagementPersonnelTelephone" label-width="168px">
                <el-input v-model="addSafeData.safetyManagementPersonnelTelephone" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="安全生产主要负责人" prop="safetyProductionMainResponsiblePerson" label-width="148px">
                <el-input v-model="addSafeData.safetyProductionMainResponsiblePerson" disabled />
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item>
            <el-button :loading="btnLoading" type="primary">确定</el-button>
            <el-button @click="addSafeDialog = false">取消</el-button>
          </el-form-item>
        </el-form>
      </el-dialog>
    </div>
    <!-- 引入全局地图 -->
    <div>
      <baidu-map
        :zoom="zoom"
        style="width: 100%;height:300px;"
        :scroll-wheel-zoom="true"
        @ready="bigEnterpriseMap"
      />
    </div>
    <!-- 查看弹窗图片 -->
    <el-dialog append-to-body :visible.sync="dialogViewPics">
      <el-row :gutter="20" type="flex" justify="center">
        <el-col v-for="(item,index) in registerCertificates" :key="index" :span="8">
          <el-image style="width:100%" :src="item.url" />
        </el-col>
      </el-row>
    </el-dialog>
  </div>
</template>

<script>
import { validateIsPhone } from '@/utils/regList'
import { getEnterpriseOptions } from '@/api/config/index'
import { enterpriseBasicInfoList, enterpriseBasicInfoDelete, enterpriseBasicInfoAdd, enterpriseBasicInfoUpdate, safeProductionInfoList } from '@/api/basedata/baseInfo'
import GLOBAL from '@/utils/global'
export default {
  name: '',
  data() {
    const validatePhone = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('手机号码不能为空'))
      }
      if (!validateIsPhone(value)) {
        callback(new Error('请输入正确的手机号码'))
      }
      callback()
    }
    return {
      /* 搜索栏显示 */
      params: {
        enterpriseIds: [],
        enterpriseId: null,
        enterpriseName: '',
        page: 1,
        size: 10
      },
      page: { list: [], page: 0, size: 0, total: 0, totalPage: 0 },
      pageSafe: { list: [], pageSafe: 0, sizeSafe: 0, total: 0, totalPage: 0 },
      editEnterpriseData: {
        enterpriseName: '',
        certificateType: '',
        unitCategory: '',
        registerAddress: '',
        creditCode: '',
        businessAddress: '',
        businessLicenseCategory: '',
        legalRepresentative: '',
        contactNumber: '',
        state: '',
        industryCategory: '',
        registerCertificates: [],
        fileIds: [],
        scale: '',
        enterpriseId: '',
        registerValidityEndTime: '',
        registerValidityStartTime: '',
        economicType: '',
        onDutyEmployeeNumber: '',
        parentName: '',
        id: '',
        registerValidity: [new Date(), new Date()], // 注意：存储的是我的两个时间段
        registerValidity: null, // 注意：存储的是我的两个时间段
        projectGPSCoordinates: {
          lng: '',
          lat: ''
        }
      },
      editSafeData: {
        safetyProductionMainResponsiblePerson: '',
        employeeNumber: '',
        safetyProductionMainResponsiblePersonContactNumber: '',
        registerSafeEngineerNumber: '',
        inChargeOfSafety: '',
        specialWorkNumber: '',
        enterpriseIds: '',
        inChargeOfSecurityResponsiblePersonTelephone: '',
        productionState: '',
        safeManageEmployeeNumber: '',
        safetyManagementPersonnel: '',
        safetyManagementPersonnelTelephone: '',
        RegistrationDocumentUpload: '',
        registerValidity: [new Date(), new Date()], // 注意：存储的是我的两个时间段
        registerValidityStartTime: '',
        registerValidityEndTime: '',
        productionLicenseValidity: [new Date(), new Date()], // 注意：存储的是我的两个时间段
        productionLicenseValidityStartTime: '',
        productionLicenseValidityEndTime: '',
        unitOnDutyPhone: '',
        safeOrganizationSetting: [],
        parentName: '',
        email: ''
      },
      addEnterpriseData: {
        enterpriseName: '',
        certificateType: '',
        unitCategory: '',
        state: '',
        registerValidityStartTime: new Date(),
        registerValidityEndTime: new Date(),
        registerAddress: '',
        enterpriseId: '',
        creditCode: '',
        businessAddress: '',
        businessLicenseCategory: '',
        legalRepresentative: '',
        contactNumber: '',
        businessScope: '',
        industryCategory: '',
        registerCertificates: [],
        fileIds: [],
        scale: '',
        economicType: '',
        parentName: '',
        onDutyemployeeNumber: 0,
        externalWorkerNumber: 0,
        registerValidity: [new Date(), new Date()], // 注意：存储的是我的两个时间段
        projectGPSCoordinates: {
          lng: '',
          lat: ''
        }
      },
      addSafeData: {
        safetyProductionMainResponsiblePerson: '',
        employeeNumber: '',
        safeManageEmployeeNumber: '',
        safetyProductionMainResponsiblePersonContactNumber: '',
        enterpriseIds: '',
        registerSafeEngineerNumber: '',
        inChargeOfSafety: '',
        specialWorkNumber: '',
        inChargeOfSecurityResponsiblePersonTelephone: '',
        productionState: '',
        safetyManagementPersonnel: '',
        registerValidity: [new Date(), new Date()], // 注意：存储的是我的两个时间段
        registerValidityStartTime: '',
        registerValidityEndTime: '',
        productionLicenseValidity: [new Date(), new Date()], // 注意：存储的是我的两个时间段
        productionLicenseValidityStartTime: '',
        productionLicenseValidityEndTime: '',
        safetyManagementPersonnelTelephone: '',
        RegistrationDocumentUpload: '',
        unitOnDutyPhone: '',
        safeOrganizationSetting: [],
        parentName: '',
        email: ''
      },
      enterpriseRules: {
        contactNumber: [{ validator: validatePhone, trigger: 'blur' },
          { validator: validatePhone, trigger: 'change' }],
        state: [{ required: true, message: '企业状态不能为空', trigger: 'blur' }],
        enterpriseId: [
          { required: true, message: '企业名称不能为空', trigger: 'blur' }
          { required: true, message: '企业名称不能为空', trigger: 'blur' }, { message: '企业名称不能为空', required: true, trigger: 'change' }
        ],
        certificateType: [
          { required: true, message: '代码证类型不能为空', trigger: 'blur' }
        ],
        unitCategory: [
          { required: true, message: '单位类别不能为空', trigger: 'blur' }
        ],
        externalWorkerNumber: [{ required: true, message: '外用工人数不能为空', trigger: 'blur' }
        ],
        registerAddress: [
          { required: true, message: '注册地址不能为空', trigger: 'blur' }
        ],
        creditCode: [
          { required: true, message: '统一社会信用代码不能为空', trigger: 'blur' }
        ],
        businessAddress: [
          { required: true, message: '生产经营地址不能为空', trigger: 'blur' }
        ],
        businessLicenseCategory: [
          { required: true, message: '营业执照类别不能为空', trigger: 'blur' }
        ],
        legalRepresentative: [
          { required: true, message: '法定代表人不能为空', trigger: 'blur' }
        ],
        onDutyemployeeNumber: [{ required: true, message: '在岗工人数不能为空', trigger: 'blur' }],
        businessScope: [
          { required: true, message: '经营范围不能为空', trigger: 'blur' }
        ],
        industryCategory: [
          { required: true, message: '行业类别不能为空', trigger: 'blur' }
        ],
        registerValidity: [
        registerValidityEndTime: [
          { required: true, message: '工商登记有效期不能为空', trigger: 'blur' }
        ],
        scale: [
          { required: true, message: '行业规模不能为空', trigger: 'blur' }
        ],
        economicType: [
          { required: true, message: '经济类型不能为空', trigger: 'blur' }
        ],
        registerCertificates: [
          { required: true, message: '注册证件上传不能为空', trigger: 'blur' }
        ],
        officeLocationGPSCoordinates: [
          { required: true, message: '办公地点GPS坐标不能为空', trigger: 'blur' }
        ]
      },
      rulesSafe: {
        parentName: [
          { required: true, message: '父级单位不能为空', trigger: 'blur' }
        ],
        safetyProductionMainResponsiblePerson: [
          { required: true, message: '安全生产主要负责人不能为空', trigger: 'blur' }
        ],
        employeeNumber: [
          { required: true, message: '从业人数不能为空', trigger: 'blur' }
        ],
        safetyProductionMainResponsiblePersonContactNumber: [
          { required: true, message: '安全生产主要负责人联系电话不能为空', trigger: 'blur' }
        ],
        registerSafeEngineerNumber: [
          { required: true, message: '注册安全工程师人数不能为空', trigger: 'blur' }
        ],
        inChargeOfSafety: [
          { required: true, message: '分管安全负责人不能为空', trigger: 'blur' }
        ],
        specialWorkNumber: [
          { required: true, message: '特种作业人数不能为空', trigger: 'blur' }
        ],
        inChargeOfSecurityResponsiblePersonTelephone: [
          { required: true, message: '分管安全负责人电话不能为空', trigger: 'blur' }
        ],
        productionState: [
          { required: true, message: '生产状态不能为空', trigger: 'blur' }
        ],
        safetyManagementPersonnel: [
          { required: true, message: '专职安全管理人员不能为空', trigger: 'blur' }
        ],
        safetyManagementPersonnelTelephone: [
          { required: true, message: '专职安全管理人员电话不能为空', trigger: 'blur' }
        ],
        RegistrationDocumentUpload: [
          { required: true, message: '许可证扫描件上传不能为空', trigger: 'blur' }
        ],
        unitOnDutyPhone: [
          { required: true, message: '单位值班电话不能为空', trigger: 'blur' }
        ],
        email: [
          { required: true, message: '电子邮箱不能为空', trigger: 'blur' }
        ]
      },
      locData: {
        ids: 0,
        lng: '',
        lat: ''
      },
      // 大地图固定死的显示
      projectGPSCoordinatesCenter: [
        [106.653298, 29.732213, '江西核工业工程地质勘察'],
        [115.807698, 28.662684, '江西核工业测绘院'],
        [116.412222, 39.912345, '江西省核工业地质局二六四大队'],
        [111.716982, 40.890667, '江西省核工业地质局二六六大队']
      ],
      projectGPSCoordinates: {
        lng: 0,
        lat: 0
      },
      registerValidity: null,
      productionLicenseValidity: null,
      pageEnterpriseLoading: true,
      pageSafeLoading: true,
      dialogImageUrl: '',
      registerCertificates: [],
      activeName: 'second',
      activeName: 'first',
      enterpriseOptions: [],
      dialogViewPics: false,
      btnLoading: false,
      editEnterpriseDialog: false,
      addEnterpriseDialog: false,
      editSafeDialog: false,
      addSafeDialog: false,
      // 引入百度地图默认倍数
      zoom: 11,
      /* 默认只要打开另一个就关闭之前的 */
      getRowKeys(row) {
        return row.id
      },
      expands: []
    }
  },
  created() {
    getEnterpriseOptions().then(res => {
      this.enterpriseOptions = res.data.obj
    })
    this.fetchData()
    this.fetchSafeData()
    this.fetchData()
  },
  methods: {
    // 获取信息
    fetchData() {
      if (this.params.enterpriseIds.length !== 0) {
        this.params.enterpriseId = this.params.enterpriseIds[this.params.enterpriseIds.length - 1]
      }
      enterpriseBasicInfoList(this.params).then(res => {
        this.pageEnterpriseLoading = false
        this.page = res.data.obj
        getEnterpriseOptions().then(res => {
          this.enterpriseOptions = res.data.obj
        })
      })
    },
    fetchSafeData() {
      safeProductionInfoList(this.params).then(res => {
        this.pageSafeLoading = false
        this.pageSafe = res.data.obj
      })
    },
    editEnterpriseChangeData() {
      // 企业基本信息的修改
      if (this.editEnterpriseData.registerValidity === [] || this.editEnterpriseData.registerValidity[0] === null || this.editEnterpriseData.registerValidity[1] === null) {
      console.log(this.editEnterpriseData)
      // 企业基本信息的 【登记有效期】 修改
      if (this.registerValidity === null || this.registerValidity[0] === null || this.registerValidity[1] === null) {
        this.editEnterpriseData.registerValidityStartTime = null
        this.editEnterpriseData.registerValidityEndTime = null
        return
      }
      this.editEnterpriseData.registerValidityStartTime = this.editEnterpriseData.registerValidity[0]
      this.editEnterpriseData.registerValidityEndTime = this.editEnterpriseData.registerValidity[1]
      this.editEnterpriseData.registerValidityStartTime = this.registerValidity[0]
      this.editEnterpriseData.registerValidityEndTime = this.registerValidity[1]
    },
    addEnterpriseChangeData() {
      // 企业基本信息的修改
      // 企业基本信息的 【登记有效期】 添加
      if (this.addEnterpriseData.registerValidity === [] || this.addEnterpriseData.registerValidity[0] === null || this.addEnterpriseData.registerValidity[1] === null) {
        return
      }
      this.addEnterpriseData.registerValidityStartTime = this.addEnterpriseData.registerValidity[0]
      this.addEnterpriseData.registerValidityEndTime = this.addEnterpriseData.registerValidity[1]
    },
    editSafeChangeData() {
      if (this.editSafeData.productionLicenseValidity === [] || this.editSafeData.productionLicenseValidity[0] === null || this.editSafeData.productionLicenseValidity[1] === null) {
        return
      }
      this.editSafeData.productionLicenseValidityStartTime = this.editSafeData.productionLicenseValidity[0]
      console.log(this.editSafeData.productionLicenseValidityStartTime)
      this.editSafeData.productionLicenseValidityEndTime = this.editSafeData.productionLicenseValidity[1]
      console.log(this.editSafeData.productionLicenseValidityEndTime)
      if (this.editSafeData.registerValidity === [] || this.editSafeData.registerValidity[0] === null || this.editSafeData.registerValidity[1] === null) {
        return
      }
      this.editSafeData.registerValidityStartTime = this.editSafeData.registerValidity[0]
      this.editSafeData.registerValidityEndTime = this.editSafeData.registerValidity[1]
    },
    addSafeChangeData() {
      if (this.addSafeData.productionLicenseValidity === [] || this.addSafeData.productionLicenseValidity[0] === null || this.addSafeData.productionLicenseValidity[1] === null) {
        return
      }
      this.addSafeData.productionLicenseValidityStartTime = this.addSafeData.productionLicenseValidity[0]
      this.addSafeData.productionLicenseValidityEndTime = this.addSafeData.productionLicenseValidity[1]
      if (this.addSafeData.registerValidity === [] || this.addSafeData.registerValidity[0] === null || this.addSafeData.registerValidity[1] === null) {
        return
      }
      this.addSafeData.registerValidityStartTime = this.addSafeData.registerValidity[0]
      this.addSafeData.registerValidityEndTime = this.addSafeData.registerValidity[1]
    },
    // 设置当前对象所在的下标，用于点击详情前获取数组中该对象的经纬度
    setCurrentIndex(index) {
      if (this.page.list.length === 0) {
        return
      }
      this.page.list[index].index = index
    },
    // 折叠面板每次只能展开一行
    expandSelect(row, expandedRows) {
      var that = this
      if (expandedRows.length) {
        that.expands = []
        if (row) {
          this.projectGPSCoordinates.lng = row.gpsLng
          this.projectGPSCoordinates.lat = row.gpsLat
          // 打开当前点击的 详情
          that.expands.push(row.id)// 每次push进去的是每行的ID
        }
      } else {
        that.expands = []// 默认不展开
      }
    },
    handleEditEnterpriseChange(value) {
      if (value !== null || value !== []) {
      if (value !== null && value !== []) {
        this.editEnterpriseData.enterpriseId = value[value.length - 1]
        this.addEnterpriseData.parentName = this.getParentName(value)
      }
    },
    handleAddEnterpriseChange(value) {
      if (value !== null || value !== []) {
      if (value !== null && value !== []) {
        this.addEnterpriseData.enterpriseId = value[value.length - 1]
        this.addEnterpriseData.parentName = this.getParentName(value)
      }
    },
    handleEditSafeChange(value) {
      if (value !== null || value !== []) {
        this.editSafeData.enterpriseId = value[value.length - 1]
      }
    },
    handleAddSafeChange(value) {
      if (value !== null || value !== []) {
        this.addSafeData.enterpriseId = value[value.length - 1]
        this.addSafeData.parentName = this.getParentName(value)
      }
    },
    // 获取父级单位名称
    getParentName(enterpriseIds) {
      var parentName = null
      try {
        if (enterpriseIds.length === 2) {
          this.enterpriseOptions.forEach(e => {
            e.children.forEach(ce => {
              if (ce.value === enterpriseIds[1]) {
                parentName = e.label
                throw new Error(parentName)
              }
            })
          })
        }
      } catch (e) {
        console.log(e.message)
      }
      return parentName
    },
    // 详情里面的小地图
    smallEnterpriseMap({ BMap, map }) {
      var point = new BMap.Point(this.projectGPSCoordinates.lng, this.projectGPSCoordinates.lat) // 初始化地图,设置中心点坐标和地图级别
      map.centerAndZoom(point, this.zoom)
      var marker = new BMap.Marker(point) // 创建标注
      map.addOverlay(marker) // 将标注添加到地图中
      /* var circle = new BMap.Circle(point, 6, {
        strokeColor: 'Red',
        strokeWeight: 6,
        strokeOpacity: 1,
        Color: 'Red',
        fillColor: '#f03'
      })
      // 将标注添加到地图中,底下的小圆点
      map.addOverlay(circle) */
    },
    // 页面底下的地图
    bigEnterpriseMap({ BMap, map }) {
      map.centerAndZoom(new BMap.Point(104.769128, 34.972443), 5)
      var data_info = this.projectGPSCoordinatesCenter
      var opts = {
        width: 250, // 信息窗口宽度
        height: 60, // 信息窗口高度
        title: '信息窗口', // 信息窗口标题
        enableMessage: true // 设置允许信息窗发送短息
      }
      for (var i = 0; i < data_info.length; i++) {
        var marker = new BMap.Marker(
          new BMap.Point(data_info[i][0], data_info[i][1])
        )
        // 创建标注
        var content = data_info[i][2]
        map.addOverlay(marker)
        var label = new BMap.Label(data_info[i][2], { offset: new BMap.Size(GLOBAL.BMAP_LABEL_OFFSET.width, GLOBAL.BMAP_LABEL_OFFSET.height) })
        marker.setLabel(label)
        // 将标注添加到地图中
        addClickHandler(content, marker)
      }
      function addClickHandler(content, marker) {
        marker.addEventListener('click', function(e) {
          openInfo(content, e)
        })
      }
      function openInfo(content, e) {
        var p = e.target
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat)
        var infoWindow = new BMap.InfoWindow(content, opts) // 创建信息窗口对象
        map.openInfoWindow(infoWindow, point) // 开启信息窗口
      }
    },
    // 点击添加修改 弹窗里面的小地图，添加默认根据ip来定位
    editEnterpriseDialogMap({ BMap, map }) {
      window.map = map // 将map变量存储在全局
      var point = new BMap.Point(this.locData.lng, this.locData.lat) // 初始化地图,设置中心点坐标和地图级别
      map.centerAndZoom(point, this.zoom)
      var marker = new BMap.Marker(point) // 创建标注
      map.addOverlay(marker) // 将标注添加到地图中
    },
    addEnterpriseDialogMap({ BMap, map }) {
      window.map = map // 将map变量存储在全局
      var point = new BMap.Point(116.331398, 39.897445)
      map.centerAndZoom(point, this.zoom)
      function myFun(result) {
        var cityName = result.name
        map.setCenter(cityName)
      }
      var myCity = new BMap.LocalCity()
      myCity.get(myFun)
    },
    // 点击添加和修改里面的弹窗-点击获取地点
    getAddEnterpriseClickInfoMap(e) {
      // 清除所要清除的覆盖物
      map.clearOverlays()
      var myMarker = new BMap.Marker(new BMap.Point(e.point.lng, e.point.lat))
      map.addOverlay(myMarker)
      this.locData.lng = e.point.lng
      this.locData.lat = e.point.lat
    },
    getEditEnterpriseClickInfoMap(e) {
      // 清除所要清除的覆盖物
      map.clearOverlays()
      var myMarker = new BMap.Marker(new BMap.Point(e.point.lng, e.point.lat))
      map.addOverlay(myMarker)
      this.locData.lng = e.point.lng
      this.locData.lat = e.point.lat
    },
    // 关闭按钮
    handleClose(done) {
      this.$confirm('确认关闭？')
        .then(_ => {
          done()
        })
        .catch(_ => {})
    },
    // 安全生产信息
    editOpenSafeDialog(index, row) {
      this.editSafeDialog = true // 编辑信息模态框显示
      // 获得所有数据显示在编辑信息模态框里面;
      this.editSafeData = Object.assign({}, row)
      // this.registerValidity = [this.editSafeData.registerValidityStartTime, this.editSafeData.registerValidityEndTime]
      this.productionLicenseValidity = [this.editSafeData.productionLicenseValidityStartTime, this.editSafeData.productionLicenseValidityEndTime]
      // console.log('时间是：' +  this.registerValidity)
      this.editSafeDialog = true // 编辑信息模态框显示
    },
    // 企业基本信息-增删改
    submitEnterpriseAddForm(formName) {
      this.addEnterpriseData.gpsLng = this.locData.lng
      this.addEnterpriseData.gpsLat = this.locData.lat
      this.$refs[formName].validate(valid => {
        if (!this.addEnterpriseData.gpsLng || !this.addEnterpriseData.gpsLat) {
          this.$message.error('请选择办公地点坐标')
          return
        }
        if (!this.addEnterpriseData.enterpriseIds) {
          this.$message.error('请选择企业名称')
          return
        }
        if (valid) {
          this.btnLoading = false
          enterpriseBasicInfoAdd(this.addEnterpriseData).then(res => {
            if (res.data.status === 200) {
              this.$message.success('添加成功!')
              // this.$message.success('添加成功!')
              this.fetchData()
              this.addEnterpriseDialog = false
            } else {
              this.$message.error('添加失败，请重试联系管理员!')
              this.$message.error(res.data.msg)
            }
          }).catch(() => {
            this.$message.error('添加失败!')
          })
        }
      })
    },
    submitEnterpriseEditForm(formName) {
      this.editEnterpriseData.gpsLng = this.locData.lng
      this.editEnterpriseData.gpsLat = this.locData.lat
      this.$refs[formName].validate(valid => {
        if (valid) {
          this.btnLoading = false
          enterpriseBasicInfoUpdate(this.editEnterpriseData).then(res => {
            if (res.data.status === 200) {
              this.$message.success('修改成功!')
              // this.$message.success('修改成功!')
              this.fetchData()
              this.editEnterpriseDialog = false
            } else {
              this.$message.error('修改失败，请重试联系管理员!')
              this.$message.error(res.data.msg)
            }
          }).catch(() => {
            this.$message.error('修改失败!')
          })
        }
      })
    },
    delEnterprise(index, row) {
      this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      })
        .then(() => {
          enterpriseBasicInfoDelete(Object.assign({}, row).id).then(res => {
            this.page.list.splice(index, 1)
            this.fetchData()
            this.$message({
              type: 'success',
              message: '删除成功!'
            })
          })
        })
    },
    editOpenEnterpriseDialog(index, row) {
      // 获得所有数据显示在编辑信息模态框里面;
      this.editEnterpriseData = Object.assign({}, row)
      this.projectGPSCoordinates.lng = this.editEnterpriseData.gpsLng
      this.projectGPSCoordinates.lat = this.editEnterpriseData.gpsLat
      this.locData = this.projectGPSCoordinates
      this.editEnterpriseData.registerValidity = [this.editEnterpriseData.registerValidityStartTime, this.editEnterpriseData.registerValidityEndTime]
      this.registerValidity = [this.editEnterpriseData.registerValidityStartTime, this.editEnterpriseData.registerValidityEndTime]
      // this.editEnterpriseData.registerValidity = [this.editEnterpriseData.registerValidityStartTime, this.editEnterpriseData.registerValidityEndTime]
      this.editEnterpriseData.fileIds = []
      const urlPre = process.env.VUE_APP_BASE_API
      this.editEnterpriseData.registerCertificates.forEach((e, index) => {
        this.editEnterpriseData.fileIds.push(e.fileId)
        e.url = urlPre + e.url
      })
      this.editEnterpriseData.enterpriseIds = this.editEnterpriseData.enterpriseType === 'D' ? [this.editEnterpriseData.enterpriseId] : [this.editEnterpriseData.parentId, this.editEnterpriseData.enterpriseId]
      this.editEnterpriseDialog = true // 编辑信息模态框显示
    },
    // 企业基本信息分页
    handleSizeChangeEnterprise(val) {
      console.log(`每页 ${val} 条`)
      this.params.size = val
      this.fetchSafeData()
    },
    handleCurrentChangeEnterprise(val) {
      console.log(`当前页: ${val}`)
      this.params.page = val
      this.fetchSafeData()
    },
    handleSizeChangeSafe(val) {
      console.log(`每页 ${val} 条`)
      this.params.sizeSafe = val
      this.fetchData()
    },
    handleCurrentChangeSafe(val) {
      console.log(`当前页: ${val}`)
      this.params.pageSafe = val
      this.fetchData()
    },
    // 图片管理
    handleEditSuccess(response, file, registerCertificates) {
      this.editEnterpriseData.registerCertificates = registerCertificates
      this.editEnterpriseData.fileIds.push(response.obj.fileId)
      // this.dailyLoading = false
    },
    handleAddSuccess(response, file, registerCertificates) {
      this.addEnterpriseData.fileIds.push(response.obj.fileId)
      this.addEnterpriseData.registerCertificates = registerCertificates
    },
    handleEditRemove(file, registerCertificates) {
      // 如果文件是未上传成功的直接删除就可以了，不需要执行下面的操作
      if (file.status !== 'success') {
        this.editEnterpriseData.registerCertificates = registerCertificates
        return
      }
      // 当前删除文件的 fileId，然后在fileIds里找到来删除即可3
      var delFileId = null
      for (const i in this.editEnterpriseData.registerCertificates) {
        console.log(i)
        if (this.editEnterpriseData.registerCertificates[i].uid === file.uid) {
          if (this.editEnterpriseData.registerCertificates[i].response !== undefined) {
          // 新上传的文件
            delFileId = this.editEnterpriseData.registerCertificates[i].response.obj.fileId
            break
          } else {
          // 原有的文件
            delFileId = this.editEnterpriseData.registerCertificates[i].fileId
            break
          }
        }
      }
      this.editEnterpriseData.registerCertificates = registerCertificates
      this.editEnterpriseData.fileIds.forEach((e, index) => {
        console.log(this.editEnterpriseData.fileIds)
        if (e === delFileId) {
          this.editEnterpriseData.fileIds.splice(index, 1)
          return
        }
      })
    },
    handleAddRemove(file, registerCertificates) {
      this.addEnterpriseData.registerCertificates = registerCertificates
    },
    handleSafeEditRemove(file, registerCertificates) {
    handleEditSafeSuccess(response, file, registerCertificates) {
      /*  this.addSafeData.safeOrganizationSetting = registerCertificates */
    },
    handleSafeAddRemove(file, registerCertificates) {
    handleEditSafePreview(file) {
      /*  const url = process.env.VUE_APP_BASE_API + file.response.obj.url
      window.open('http://47.99.113.105:8012/onlinePreview?url=' + encodeURIComponent(url))
      console.log('http://47.99.113.105:8012/onlinePreview?url=' + encodeURIComponent(url)) */
    },
    handlePictureCardPreview(file) {
      this.dialogImageUrl = file.url
      this.viewPics([file])
    // eslint-disable-next-line handle-callback-err
    handleEditSafeError(err, file, safeOrganizationSetting) {
      /*  this.loading = false
      if (err.status === 401) {
        this.$confirm(
          '您的登录信息已过期，您可以取消以停留在此页，或重新登录',
          '系统提示', {
            confirmButtonText: '重新登录',
            cancelButtonText: '取消',
            type: 'warning'
          }
        ).then(() => {
          this.$router.replace('/login')
        })
      }
      console.log({ ...err }) */
    },
    handleEditSafeRemove(file, registerCertificates) {
    },
    handleEditSafeProgress(event, file, safeOrganizationSetting) {
      /* this.loading = true */
    },
    handleAddSafeRemove(file, registerCertificates) {
    },
    // 图片格式
    beforeAvatarUpload(file) {
      const isJPG = file.type === 'image/jpeg'
      const isPng = file.type === 'image/png'
      const isLt2M = file.size / 1024 / 1024 < 2
      if (!isJPG && !isPng) {
        this.$message.error('上传图片只能是 JPG或png 格式!')
      }
      if (!isLt2M) {
        this.$message.error('上传图片大小不能超过 2MB!')
      }
      return (isJPG || isPng) && isLt2M
    },
    handlePictureCardPreview(file) {
      this.dialogImageUrl = file.url
      this.viewPics([file])
    },
    // 查看照片
    viewPics(registerCertificates) {
      this.dialogViewPics = true
      this.registerCertificates = registerCertificates
    },
    /* 显示图片出错时 */
    handleLoadError(e) {
      const img = e.srcElement
      this.imageUrl = this.errorLoadImg //  用加载失败的图片替代之
      img.onerror = null //  清除错误:如果错误时加载时显示的图片出错，将会一直循环，所以我们必须清除掉错误，限制运行一次
    }
  }
}
</script>

<style lang="scss" scoped>
.dashboard {
  &-container {
    margin: 30px;
  }
  &-text {
    font-size: 30px;
    line-height: 46px;
  }
}
.colBorder2{
  background-color: #F6F6F8;
}
.el-form-item--mini.el-form-item, .el-form-item--small.el-form-item{
  margin-bottom: 0;
  margin:10px;
}
.el-row{
 margin-bottom: 0;
}

// 防止提示文字被遮挡
.el-row .el-col{
  padding: 5px 0;
}
</style>
<template>
  <div class="app-container">
    <div class="panel">
      <div class="panel-title">
        <breadcrumb class="breadcrumb-container" />
      </div>
      <!-- 搜索框的按钮哟 -->
      <el-tabs v-model="activeName">
        <el-tab-pane label="企业基本信息" name="first">
          <el-row>
            <el-col :span="24">
              <el-form :inline="true" :model="params" class="demo-form-inline">
                <el-form-item label="企业名称" prop="enterpriseId" required>
                  <el-cascader
                    v-model="params.enterpriseIds"
                    style="width: 100%"
                    size="small"
                    placeholder="请选择企业"
                    :options="enterpriseOptions"
                    :props="{ checkStrictly: true }"
                    clearable
                  />
                </el-form-item>
                <el-form-item>
                  <el-input
                    v-model="params.enterpriseName"
                    placeholder="单位名称"
                    style="width:180px;"
                    size="small"
                  />
                </el-form-item>
                <el-form-item>
                  <el-button type="primary" icon="el-icon-search" size="small" @click="fetchData">查询</el-button>
                </el-form-item>
              </el-form>
            </el-col>
          </el-row>
          <el-button type="primary" size="small" @click="addEnterpriseDialog=true">
            <i class="el-icon-plus" /> 新增
          </el-button>
          <el-table v-loading="pageEnterpriseLoading" border :data="page.list" size="small" stripe :expand-row-keys="expands" :row-key="getRowKeys" empty-text="空" @expand-change="expandSelect">
            <!-- 详情展示 -->
            <el-table-column type="expand">
              <template slot-scope="props">
                <el-form class="demo-table-expand">
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="企业名称：">
                        <span>{{ props.row.enterpriseName }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="代码证类型：">
                        <span>{{ props.row.certificateType }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="单位类别：">
                        <span>{{ props.row.unitCategory }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="注册地址：">
                        <span>{{ props.row.registerAddress }}</span>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="统一社会信用代码：">
                        <span>{{ props.row.creditCode }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="生产经营地址：">

                        <span>{{ props.row.businessAddress }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="营业执照类别：">
                        <span>{{ props.row.businessLicenseCategory }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="法定代表人：">
                        <span>{{ props.row.legalRepresentative }}</span>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="法定代表人联系电话：">
                        <span>{{ props.row.contactNumber }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="经营范围：">
                        <span>{{ props.row.businessScope }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="行业类别：">
                        <span>{{ props.row.industryCategory }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="工商登记有效期：">
                        <el-tag size="small">{{ props.row.registerValidityStartTime| dateFormat('YYYY年MM月DD日') }}</el-tag>
                        <el-tag size="small" type="success">{{ props.row.registerValidityEndTime| dateFormat('YYYY年MM月DD日') }}</el-tag>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="企业规模：">
                        <span>{{ props.row.scale }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="经济类型：">
                        <span>{{ props.row.economicType }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="父级单位：">
                        <span>{{ props.row.parentName }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="在岗员工数：">
                        <span>{{ props.row.onDutyemployeeNumber }}</span>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="12" class="colBorder">
                      <el-form-item label="注册证件上传：">
                        <el-image v-for="item in props.row.registerCertificates" :key="item.id" :src="'http://192.168.100.2:8080' + item.url" style="width:150px; height: 150px">
                          {{ 'http://192.168.100.2:8080' + item.url }}
                        </el-image>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="外用工人数：">
                        <span>{{ props.row.externalWorkerNumber }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6">
                      <el-form-item label="企业状态">
                        <span>{{ props.row.state }}</span>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="12">
                      <el-form-item label="办公地点GPS坐标：">
                        <baidu-map
                          :center="props.row.projectGPSCoordinates"
                          :zoom="zoom"
                          style="float:left; width: 400px; height: 280px"
                          :scroll-wheel-zoom="true"
                          @ready="smallEnterpriseMap"
                        />
                      </el-form-item>
                    </el-col>
                  </el-row>
                </el-form>
              </template>
            </el-table-column>
            <el-table-column sortable prop="enterpriseName" label="企业名称" />
            <el-table-column sortable prop="legalRepresentative" label="法定代表人" />
            <el-table-column sortable prop="contactNumber" label="联系电话" />
            <el-table-column sortable prop="parentName" label="父级单位" />
            <el-table-column label="操作">
              <template slot-scope="scope">
                {{ setCurrentIndex(scope.$index) }}
                <el-button
                  type="text"
                  size="small"
                  @click="editOpenEnterpriseDialog(scope.$index,scope.row)"
                >编辑</el-button>
                <el-button type="text" size="small" @click="delEnterprise(scope.$index,scope.row)">删除</el-button>
              </template>
            </el-table-column>
          </el-table>
          <!-- 分页栏 -->
          <el-row>
            <!-- 分页栏 -->
            <el-pagination
              class="pagination"
              layout="total, sizes, prev, pager, next, jumper"
              :current-page="page.page"
              :total="page.total"
              :page-sizes="[10, 20, 50, 100]"
              @size-change="handleSizeChangeEnterprise"
              @current-change="handleCurrentChangeEnterprise"
            />
          </el-row>
        </el-tab-pane>
        <el-tab-pane label="安全生产信息" name="second">
          <el-button type="primary" size="small" @click="addSafeDialog=true">
            <i class="el-icon-plus" /> 新增
          </el-button>
          <el-table v-loading="pageSafeLoading" :data="pageSafe.list" size="small" border style="width: 100%">
            <el-table-column type="expand">
              <template slot-scope="props">
                <el-form class="demo-table-expand">
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="企业名称：">
                        <span>{{ props.row.enterpriseName }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="安全生产主要负责人：">
                        <span>{{ props.row.safetyProductionMainResponsiblePerson }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="从业人数：">
                        <span>{{ props.row.employeeNumber }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="安全生产主要负责人联系电话：">
                        <span>{{ props.row.safetyProductionMainResponsiblePersonContactNumber }}</span>
                      </el-form-item>
                    </el-col>

                  </el-row>
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="注册安全工程师人数：">
                        <span>{{ props.row.registerSafeEngineerNumber }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="分管安全负责人：">
                        <span>{{ props.row.inChargeOfSafety }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="特种作业人数：">
                        <span>{{ props.row.specialWorkNumber }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="分管安全负责人电话：">
                        <span>{{ props.row.inChargeOfSecurityResponsiblePersonTelephone }}</span>
                      </el-form-item>
                    </el-col>

                  </el-row>
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="专职安全管理人员：">
                        <span>{{ props.row.safetyManagementPersonnel }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="安全生产许可证有效期：">
                        <span>{{ props.row.registerValidity }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="专职安全管理人员电话：">
                        <span>{{ props.row.safetyManagementPersonnelTelephone }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="工商登记有效期：">
                        <el-tag size="small">{{ props.row.productionLicenseValidityStartTime| dateFormat('YYYY年MM月DD日') }}</el-tag>
                        <el-tag size="small" type="success">{{ props.row.productionLicenseValidityEndTime| dateFormat('YYYY年MM月DD日') }}</el-tag>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="单位值班电话：">
                        <span>{{ props.row.unitOnDutyPhone }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="电子邮箱：">
                        <span>{{ props.row.email }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="父级单位：">
                        <span>{{ props.row.parentName }}</span>
                      </el-form-item>
                    </el-col>
                    <el-col :span="6" class="colBorder">
                      <el-form-item label="生产状态：">
                        <span>{{ props.row.productionState }}</span>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row>
                    <el-col :span="12" class="colBorder">
                      <el-form-item label="许可证扫描件上传：">
                        <el-image :src="props.row.licenseScanFiles" />
                      </el-form-item>
                    </el-col>
                    <el-col :span="12" class="colBorder">
                      <el-form-item label="安全机构设置：">
                        <el-image :src="props.row.safeOrganizationSetting" />
                      </el-form-item>
                    </el-col>
                  </el-row>

                </el-form>

              </template>
            </el-table-column>
            <el-table-column prop="safetyProductionMainResponsiblePerson" label="安全生产主要负责人" />
            <el-table-column prop="safetyProductionMainResponsiblePersonContactNumber" label="安全生产主要负责人联系电话" />
            <el-table-column prop="unitOnDutyPhone" label="单位值班电话" />
            <el-table-column sortable prop="parentName" label="父级单位" />
            <el-table-column label="操作">
              <template slot-scope="scope">
                <el-button
                  type="text"
                  size="small"
                  @click="editOpenSafeDialog(scope.$index,scope.row)"
                >编辑</el-button>
                <el-button type="text" size="small">删除</el-button>
              </template>
            </el-table-column>

            <!-- 分页栏 -->
            <el-row>
              <!-- 分页栏 -->
              <el-pagination
                class="pagination"
                layout="total, sizes, prev, pager, next, jumper"
                :current-page="page.page"
                :total="page.total"
                :page-sizes="[10, 20, 50, 100]"
                @size-change="handleSizeChangeSafe"
                @current-change="handleSizeChangeSafe"
              />
            </el-row>
          </el-table>
        </el-tab-pane>
      </el-tabs>
      <!-- 企业基本信息-修改 -->
      <el-dialog title="企业基本信息-修改" :visible.sync="editEnterpriseDialog" width="72%" :before-close="handleClose">
        <el-form ref="editEnterpriseData" :rules="enterpriseRules" size="small" :model="editEnterpriseData" label-width="150px">
          <el-row>
            <el-col :span="6" class="colBorder2" style="background-color:#F6F6F8;">
              <el-form-item label="企业名称" label-width="78px" prop="enterpriseIds">
                <el-cascader
                  v-model="editEnterpriseData.enterpriseIds"
                  style="width: 100%"
                  size="small"
                  placeholder="请选择企业"
                  :options="enterpriseOptions"
                  :props="{ checkStrictly: true }"
                  clearable
                  @change="handleEditEnterpriseChange"
                />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="代码证类型" prop="certificateType" label-width="94px">
                <el-input v-model="editEnterpriseData.certificateType" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="单位类别" label-width="78px" prop="unitCategory">
                <el-input v-model="editEnterpriseData.unitCategory" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="注册地址" prop="registerAddress" label-width="78px">
                <el-input v-model="editEnterpriseData.registerAddress" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="统一社会信用代码" prop="creditCode" label-width="135px">
                <el-input v-model="editEnterpriseData.creditCode" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="生产经营地址" prop="businessAddress" label-width="108px">
                <el-input v-model="editEnterpriseData.businessAddress" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="营业执照类别" prop="businessLicenseCategory" label-width="108px">
                <el-input v-model="editEnterpriseData.businessLicenseCategory" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="法定代表人" prop="legalRepresentative" label-width="94px">
                <el-input v-model="editEnterpriseData.legalRepresentative" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="法定代表人联系电话" prop="contactNumber" label-width="148px" required>
                <el-input v-model="editEnterpriseData.contactNumber" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="经营范围" prop="businessScope" label-width="78px">
                <el-input v-model="editEnterpriseData.businessScope" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="行业类别" prop="industryCategory" label-width="78px">
                <el-input v-model="editEnterpriseData.industryCategory" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="外用工人数" prop="externalWorkerNumber" label-width="92px">
                <el-input-number v-model="editEnterpriseData.externalWorkerNumber" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="企业规模" prop="scale" label-width="78px">
                <el-input v-model="editEnterpriseData.scale" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="经济类型" prop="economicType" label-width="78px">
                <el-input v-model="editEnterpriseData.economicType" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="上级单位" prop="parentName" label-width="78px">
                <el-input v-model="editEnterpriseData.parentName" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="在岗员工数" prop="onDutyemployeeNumber" label-width="92px">
                <el-input-number v-model="editEnterpriseData.onDutyemployeeNumber" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="企业状态" prop="state" label-width="78px">
                <el-input v-model="editEnterpriseData.state" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="工商登记有效期" prop="registerValidity" label-width="120px">
                <el-date-picker
                  v-model="editEnterpriseData.registerValidity"
                  type="daterange"
                  align="right"
                  range-separator="至"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
                  format="yyyy-MM-dd"
                  value-format="yyyy-MM-dd"
                  @change="editEnterpriseChangeData"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col>
              <el-form-item label="注册证件" prop="registerCertificates">
                <el-upload
                  list-type="picture-card"
                  :on-success="handleEditSuccess"
                  :on-preview="handlePictureCardPreview"
                  :on-remove="handleEditRemove"
                  :before-upload="beforeAvatarUpload"
                  :file-list="editEnterpriseData.registerCertificates"
                  :data="GLOBAL.FILE_TYPE.RULES"
                  action="/api/ajax/upload"
                  @error="handleLoadError"
                >
                  <i class="el-icon-upload" />
                  <span style="color: #606266;">点击上传</span>
                </el-upload>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="24">
              <el-form-item label="办公地点GPS坐标">
                <el-input v-model="locData.lng" style="width:150px;" />
                <el-input v-model="locData.lat" style="width:150px;" />
                <baidu-map
                  :center="editEnterpriseData.projectGPSCoordinates"
                  :zoom="zoom"
                  style="width: 100%; height: 280px"
                  ak="sCrmUchPh7eKuHSyuZKx0e1acqyk7REF"
                  :scroll-wheel-zoom="true"
                  @ready="editEnterpriseDialogMap"
                  @click="getEditEnterpriseClickInfoMap"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item>
            <el-button :loading="btnLoading" type="primary" @click="submitEnterpriseEditForm('editEnterpriseData')">确定</el-button>
            <el-button @click="editEnterpriseDialog = false">取消</el-button>
          </el-form-item>
        </el-form>
      </el-dialog>
      <!-- 企业基本信息-新增 -->
      <el-dialog title="企业基本信息-新增" :visible.sync="addEnterpriseDialog" width="72%" :before-close="handleClose">
        <el-form
          id="addEnterpriseData"
          ref="addEnterpriseData"
          size="small"
          :model="addEnterpriseData"
          :rules="enterpriseRules"
        >
          <el-row>
            <el-col :span="6" class="colBorder2" style="background-color:#F6F6F8;">
              <el-form-item label="企业名称" required label-width="78px" prop="enterpriseIds">
                <el-cascader
                  v-model="addEnterpriseData.enterpriseIds"
                  style="width: 100%"
                  size="small"
                  placeholder="请选择企业"
                  :options="enterpriseOptions"
                  :props="{ checkStrictly: true }"
                  clearable
                  @change="handleAddEnterpriseChange"
                />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="代码证类型" prop="certificateType" label-width="94px">
                <el-input v-model="addEnterpriseData.certificateType" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="单位类别" label-width="78px" prop="unitCategory">
                <el-input v-model="addEnterpriseData.unitCategory" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="注册地址" prop="registerAddress" label-width="78px">
                <el-input v-model="addEnterpriseData.registerAddress" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="统一社会信用代码" prop="creditCode" label-width="135px">
                <el-input v-model="addEnterpriseData.creditCode" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="生产经营地址" prop="businessAddress" label-width="108px">
                <el-input v-model="addEnterpriseData.businessAddress" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="营业执照类别" prop="businessLicenseCategory" label-width="108px">
                <el-input v-model="addEnterpriseData.businessLicenseCategory" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="法定代表人" prop="legalRepresentative" label-width="94px">
                <el-input v-model="addEnterpriseData.legalRepresentative" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="法定代表人联系电话" prop="contactNumber" label-width="148px" required>
                <el-input v-model="addEnterpriseData.contactNumber" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="经营范围" prop="businessScope" label-width="78px">
                <el-input v-model="addEnterpriseData.businessScope" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="行业类别" prop="industryCategory" label-width="78px">
                <el-input v-model="addEnterpriseData.industryCategory" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="外用工人数" prop="externalWorkerNumber" label-width="92px">
                <el-input-number v-model="addEnterpriseData.externalWorkerNumber" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="企业规模" prop="scale" label-width="78px">
                <el-input v-model="addEnterpriseData.scale" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="经济类型" prop="economicType" label-width="78px">
                <el-input v-model="addEnterpriseData.economicType" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="上级单位" prop="parentName" label-width="78px">
                <el-input v-model="addEnterpriseData.parentName" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="在岗员工数" prop="onDutyemployeeNumber" label-width="92px">
                <el-input-number v-model="addEnterpriseData.onDutyemployeeNumber" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder2">
              <el-form-item label="企业状态" prop="state" label-width="78px">
                <el-input v-model="addEnterpriseData.state" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="工商登记有效期" prop="registerValidity" label-width="120px">
                <el-date-picker
                  v-model="addEnterpriseData.registerValidity"
                  type="daterange"
                  align="right"
                  unlink-panel
                  range-separator="至"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
                  @change="addEnterpriseChangeData"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="24">
              <el-form-item label="注册证件" prop="registerCertificates">
                <el-upload
                  v-model="addEnterpriseData.registerCertificates"
                  :on-success="handleAddSuccess"
                  action="/api/ajax/upload"
                  :on-preview="handlePictureCardPreview"
                  :on-remove="handleAddRemove"
                  :before-upload="beforeAvatarUpload"
                  :data="GLOBAL.FILE_TYPE.RULES"
                  list-type="picture-card"
                  @error="handleLoadError"
                >
                  <i class="el-icon-upload" />
                  <span style="color: #606266;">点击上传</span>
                </el-upload>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="24">
              <el-form-item label="办公地点GPS坐标" required>
                <el-row>
                  <el-col :span="8">
                    <el-row>
                      <el-col :span="12">
                        <el-input v-model="locData.lng" placeholder="坐标经度" />
                      </el-col>
                      <el-col :span="12">
                        <el-input v-model="locData.lat" placeholder="坐标纬度" style="padding-left:10px;" />
                      </el-col>
                    </el-row>
                  </el-col>
                </el-row>
                <baidu-map
                  :center="addEnterpriseData.projectGPSCoordinates"
                  :zoom="zoom"
                  style="float:left; width: 100%; height: 280px"
                  ak="sCrmUchPh7eKuHSyuZKx0e1acqyk7REF"
                  :scroll-wheel-zoom="true"
                  @ready="addEnterpriseDialogMap"
                  @click="getAddEnterpriseClickInfoMap"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-form-item>
              <el-button :loading="btnLoading" type="primary" @click="submitEnterpriseAddForm('addEnterpriseData')">确定</el-button>
              <el-button @click="addEnterpriseDialog = false">取消</el-button>
            </el-form-item>
          </el-row>
        </el-form>
      </el-dialog>

      <!-- 安全生产信息的修改 -->
      <el-dialog title="安全生产信息-修改" :visible.sync="editSafeDialog" width="60%" :before-close="handleClose">
        <el-form ref="editSafeData" :rules="rulesSafe" size="small" :model="editSafeData" label-width="150px">
          <el-row>
            <el-col :span="6" class="colBorder">
              <el-form-item label="企业名称" label-width="78px" prop="enterpriseIds">
                <el-cascader
                  v-model="editEnterpriseData.enterpriseIds"
                  style="width: 100%"
                  size="small"
                  placeholder="请选择企业"
                  :options="enterpriseOptions"
                  :props="{ checkStrictly: true }"
                  clearable
                  @change="handleEditSafeChange"
                />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="邮箱" prop="email" label-width="78px">
                <el-input v-model="editSafeData.email" disabled />
              </el-form-item>
            </el-col>

            <el-col :span="6" class="colBorder">
              <el-form-item label="从业人数" prop="employeeNumber" required label-width="78px">
                <el-input-number v-model="editSafeData.employeeNumber" :min="1" :max="2000" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="分管安全负责人" prop="inChargeOfSafety" label-width="120px">
                <el-input v-model="editSafeData.inChargeOfSafety" disabled />
              </el-form-item>
            </el-col>

          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder">
              <el-form-item label="单位值班电话" prop="unitOnDutyPhone" label-width="106px">
                <el-input v-model="editSafeData.unitOnDutyPhone" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="父级单位" prop="parentName" label-width="78px">
                <el-input v-model="editSafeData.parentName" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="特种作业人数" prop="specialWorkNumber" label-width="106px">
                <el-input-number v-model="editSafeData.specialWorkNumber" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
            <el-col :span="6">
              <el-form-item label="生产状态" prop="productionState" label-width="78px">
                <el-input v-model="editSafeData.productionState" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="10">
              <el-form-item label="注册证件" prop="RegistrationDocumentUpload" label-width="78px">
                <el-upload
                  v-model="editSafeData.RegistrationDocumentUpload"
                  action="https://jsonplaceholder.typicode.com/posts/"
                  :file-list="registerCertificates"
                  list-type="picture-card"
                  :on-preview="handlePictureCardPreview"
                  :on-remove="handleSafeEditRemove"
                  @error="handleLoadError"
                >
                  <i class="el-icon-plus" />
                </el-upload>
              </el-form-item>
            </el-col>
            <el-col :span="14">
              <el-form-item label="安全机构设置" prop="safeOrganizationSetting" label-width="106px">
                <el-upload
                  class="upload-demo"
                  drag
                  action="https://jsonplaceholder.typicode.com/posts/"
                  multiple
                >
                  <i class="el-icon-upload" />
                  <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                  <div slot="tip" class="el-upload__tip">只能上传jpg/png文件，且不超过500kb</div>
                </el-upload>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="8" class="colBorder">
              <el-form-item label="注册安全工程师人数" prop="registerSafeEngineerNumber" label-width="148px">
                <el-input-number v-model="editSafeData.registerSafeEngineerNumber" size="small" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="专职安全管理人员" prop="safetyManagementPersonnel" label-width="136px">
                <el-input v-model="editSafeData.safetyManagementPersonnel" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="分管安全负责人电话" prop="inChargeOfSecurityResponsiblePersonTelephone" label-width="148px">
                <el-input v-model="editSafeData.inChargeOfSecurityResponsiblePersonTelephone" disabled />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="9" class="colBorder">
              <el-form-item label="专职安全管理人员电话" prop="safetyManagementPersonnelTelephone" label-width="168px">
                <el-input v-model="editSafeData.safetyManagementPersonnelTelephone" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="安全生产主要负责人" prop="safetyProductionMainResponsiblePerson" label-width="148px">
                <el-input v-model="editSafeData.safetyProductionMainResponsiblePerson" disabled />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="10" class="colBorder">
              <el-form-item label="安全生产主要负责人联系电话" prop="safetyProductionMainResponsiblePersonContactNumber" required label-width="210px">
                <el-input v-model="editSafeData.safetyProductionMainResponsiblePersonContactNumber" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="9" class="colBorder">
              <el-form-item label="专职安全管理人员人数" prop="safeManageEmployeeNumber" label-width="160px">
                <el-input-number v-model="editSafeData.safeManageEmployeeNumber" size="small" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="13" class="colBorder">
              <el-form-item label="工商登记有效期" prop="productionLicenseValidity" label-width="162px">
                <el-date-picker
                  v-model="editSafeData.productionLicenseValidity"
                  type="daterange"
                  align="right"
                  range-separator="至"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
                  @change="editSafeChangeData"
                />
              </el-form-item>
            </el-col>
            <el-col :span="13" class="colBorder">
              <el-form-item label="安全生产有效期" prop="registerValidity" label-width="162px">
                <el-date-picker
                  v-model="editSafeData.registerValidity"
                  type="daterange"
                  align="right"
                  range-separator="至"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
                  @change="editSafeChangeData"
                />
              </el-form-item>
            </el-col>
          </el-row>
         
          <el-form-item>
            <el-button :loading="btnLoading" type="primary">确定</el-button>
            <el-button @click="editSafeDialog = false">取消</el-button>
          </el-form-item>
        </el-form>
      </el-dialog>
      <el-dialog title="安全生产信息-新增" :visible.sync="addSafeDialog" width="60%" :before-close="handleClose">
        <el-form
          ref="addSafeData"
          size="small"
          :model="addSafeData"
          :rules="rulesSafe"
          label-width="150px"
        >
          <el-row>
            <el-col :span="6" class="colBorder">
              <el-form-item label="企业名称" label-width="78px" prop="enterpriseIds">
                <el-cascader
                  v-model="addSafeData.enterpriseIds"
                  style="width: 100%"
                  size="small"
                  placeholder="请选择企业"
                  :options="enterpriseOptions"
                  :props="{ checkStrictly: true }"
                  clearable
                  @change="handleAddSafeChange"
                />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="邮箱" prop="email" label-width="78px">
                <el-input v-model="addSafeData.email" disabled />
              </el-form-item>
            </el-col>

            <el-col :span="6" class="colBorder">
              <el-form-item label="从业人数" prop="employeeNumber" required label-width="78px">
                <el-input-number v-model="addSafeData.employeeNumber" :min="1" :max="2000" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="分管安全负责人" prop="inChargeOfSafety" label-width="120px">
                <el-input v-model="addSafeData.inChargeOfSafety" disabled />
              </el-form-item>
            </el-col>

          </el-row>
          <el-row>
            <el-col :span="6" class="colBorder">
              <el-form-item label="单位值班电话" prop="unitOnDutyPhone" label-width="106px">
                <el-input v-model="addSafeData.unitOnDutyPhone" />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="父级单位" prop="parentName" label-width="78px">
                <el-input v-model="addSafeData.parentName" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="6" class="colBorder">
              <el-form-item label="特种作业人数" prop="specialWorkNumber" label-width="106px">
                <el-input-number v-model="addSafeData.specialWorkNumber" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
            <el-col :span="6">
              <el-form-item label="生产状态" prop="productionState" label-width="78px">
                <el-input v-model="addSafeData.productionState" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="10">
              <el-form-item label="注册证件" prop="RegistrationDocumentUpload" label-width="78px">
                <el-upload
                  v-model="addSafeData.RegistrationDocumentUpload"
                  action="https://jsonplaceholder.typicode.com/posts/"
                  :file-list="registerCertificates"
                  list-type="picture-card"
                  :on-preview="handlePictureCardPreview"
                  :on-remove="handleSafeEditRemove"
                  @error="handleLoadError"
                >
                  <i class="el-icon-plus" />
                </el-upload>
              </el-form-item>
            </el-col>
            <el-col :span="14">
              <el-form-item label="安全机构设置" prop="safeOrganizationSetting" label-width="106px">
                <el-upload
                  class="upload-demo"
                  drag
                  action="https://jsonplaceholder.typicode.com/posts/"
                  multiple
                >
                  <i class="el-icon-upload" />
                  <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                  <div slot="tip" class="el-upload__tip">只能上传jpg/png文件，且不超过500kb</div>
                </el-upload>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="8" class="colBorder">
              <el-form-item label="注册安全工程师人数" prop="registerSafeEngineerNumber" label-width="148px">
                <el-input-number v-model="addSafeData.registerSafeEngineerNumber" size="small" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="专职安全管理人员" prop="safetyManagementPersonnel" label-width="136px">
                <el-input v-model="addSafeData.safetyManagementPersonnel" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="分管安全负责人电话" prop="inChargeOfSecurityResponsiblePersonTelephone" label-width="148px">
                <el-input v-model="addSafeData.inChargeOfSecurityResponsiblePersonTelephone" disabled />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" class="colBorder">
              <el-form-item label="安全生产许可证有效期" prop="productionLicenseValidity" label-width="162px">
                <el-date-picker
                  v-model="addSafeData.productionLicenseValidity"
                  type="daterange"
                  align="right"
                  range-separator="至"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
                  @change="addSafeChangeData"
                />
              </el-form-item>
            </el-col>
            <el-col :span="12" class="colBorder">
              <el-form-item label="安全生产有效期" prop="registerValidity" label-width="162px">
                <el-date-picker
                  v-model="addSafeData.registerValidity"
                  type="daterange"
                  align="right"
                  range-separator="至"
                  start-placeholder="开始日期"
                  end-placeholder="结束日期"
                  @change="addSafeChangeData"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="8" class="colBorder">
              <el-form-item label="专职安全管理人员人数" prop="safeManageEmployeeNumber" label-width="160px">
                <el-input-number v-model="addSafeData.safeManageEmployeeNumber" size="small" :min="1" :max="1000" />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="安全生产主要负责人联系电话" prop="safetyProductionMainResponsiblePersonContactNumber" required label-width="160px">
                <el-input v-model="addSafeData.safetyProductionMainResponsiblePersonContactNumber" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="专职安全管理人员电话" prop="safetyManagementPersonnelTelephone" label-width="168px">
                <el-input v-model="addSafeData.safetyManagementPersonnelTelephone" disabled />
              </el-form-item>
            </el-col>
            <el-col :span="8" class="colBorder">
              <el-form-item label="安全生产主要负责人" prop="safetyProductionMainResponsiblePerson" label-width="148px">
                <el-input v-model="addSafeData.safetyProductionMainResponsiblePerson" disabled />
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item>
            <el-button :loading="btnLoading" type="primary">确定</el-button>
            <el-button @click="addSafeDialog = false">取消</el-button>
          </el-form-item>
        </el-form>
      </el-dialog>
    </div>
    <!-- 引入全局地图 -->
    <div>
      <baidu-map
        :zoom="zoom"
        style="width: 100%;height:300px;"
        :scroll-wheel-zoom="true"
        @ready="bigEnterpriseMap"
      />
    </div>
    <!-- 查看弹窗图片 -->
    <el-dialog append-to-body :visible.sync="dialogViewPics">
      <el-row :gutter="20" type="flex" justify="center">
        <el-col v-for="(item,index) in registerCertificates" :key="index" :span="8">
          <el-image style="width:100%" :src="item.url" />
        </el-col>
      </el-row>
    </el-dialog>
  </div>
</template>

<script>
import { validateIsPhone } from '@/utils/regList'
import { getEnterpriseOptions } from '@/api/config/index'
import { enterpriseBasicInfoList, enterpriseBasicInfoDelete, enterpriseBasicInfoAdd, enterpriseBasicInfoUpdate, safeProductionInfoList } from '@/api/basedata/baseInfo'
import GLOBAL from '@/utils/global'
export default {
  name: '',
  data() {
    const validatePhone = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('手机号码不能为空'))
      }
      if (!validateIsPhone(value)) {
        callback(new Error('请输入正确的手机号码'))
      }
      callback()
    }
    return {
      /* 搜索栏显示 */
      params: {
        enterpriseIds: [],
        enterpriseId: null,
        enterpriseName: '',
        page: 1,
        size: 10
      },
      page: { list: [], page: 0, size: 0, total: 0, totalPage: 0 },
      pageSafe: { list: [], pageSafe: 0, sizeSafe: 0, total: 0, totalPage: 0 },
      editEnterpriseData: {
        enterpriseName: '',
        certificateType: '',
        unitCategory: '',
        registerAddress: '',
        creditCode: '',
        businessAddress: '',
        businessLicenseCategory: '',
        legalRepresentative: '',
        contactNumber: '',
        state: '',
        industryCategory: '',
        registerCertificates: [],
        fileIds: [],
        scale: '',
        enterpriseId: '',
        registerValidityEndTime: '',
        registerValidityStartTime: '',
        economicType: '',
        parentName: '',
        id: '',
        registerValidity: [new Date(), new Date()], // 注意：存储的是我的两个时间段
        projectGPSCoordinates: {
          lng: '',
          lat: ''
        }
      },
      editSafeData: {
        safetyProductionMainResponsiblePerson: '',
        employeeNumber: '',
        safetyProductionMainResponsiblePersonContactNumber: '',
        registerSafeEngineerNumber: '',
        inChargeOfSafety: '',
        specialWorkNumber: '',
        enterpriseIds: '',
        inChargeOfSecurityResponsiblePersonTelephone: '',
        productionState: '',
        safeManageEmployeeNumber: '',
        safetyManagementPersonnel: '',
        safetyManagementPersonnelTelephone: '',
        RegistrationDocumentUpload: '',
        registerValidity: [new Date(), new Date()], // 注意：存储的是我的两个时间段
        registerValidityStartTime: '',
        registerValidityEndTime: '',
        productionLicenseValidity: [new Date(), new Date()], // 注意：存储的是我的两个时间段
        productionLicenseValidityStartTime: '',
        productionLicenseValidityEndTime: '',
        unitOnDutyPhone: '',
        parentName: '',
        email: ''
      },
      addEnterpriseData: {
        enterpriseName: '',
        certificateType: '',
        unitCategory: '',
        state: '',
        registerValidityStartTime: new Date(),
        registerValidityEndTime: new Date(),
        registerAddress: '',
        enterpriseId: '',
        creditCode: '',
        businessAddress: '',
        businessLicenseCategory: '',
        legalRepresentative: '',
        contactNumber: '',
        businessScope: '',
        industryCategory: '',
        registerCertificates: [],
        fileIds: [],
        scale: '',
        economicType: '',
        parentName: '',
        onDutyemployeeNumber: 0,
        externalWorkerNumber: 0,
        registerValidity: [new Date(), new Date()], // 注意：存储的是我的两个时间段
        projectGPSCoordinates: {
          lng: '',
          lat: ''
        }
      },
      addSafeData: {
        safetyProductionMainResponsiblePerson: '',
        employeeNumber: '',
        safeManageEmployeeNumber: '',
        safetyProductionMainResponsiblePersonContactNumber: '',
        enterpriseIds: '',
        registerSafeEngineerNumber: '',
        inChargeOfSafety: '',
        specialWorkNumber: '',
        inChargeOfSecurityResponsiblePersonTelephone: '',
        productionState: '',
        safetyManagementPersonnel: '',
        registerValidity: [new Date(), new Date()], // 注意：存储的是我的两个时间段
        registerValidityStartTime: '',
        registerValidityEndTime: '',
        productionLicenseValidity: [new Date(), new Date()], // 注意：存储的是我的两个时间段
        productionLicenseValidityStartTime: '',
        productionLicenseValidityEndTime: '',
        safetyManagementPersonnelTelephone: '',
        RegistrationDocumentUpload: '',
        unitOnDutyPhone: '',
        parentName: '',
        email: ''
      },
      enterpriseRules: {
        contactNumber: [{ validator: validatePhone, trigger: 'blur' },
          { validator: validatePhone, trigger: 'change' }],
        state: [{ required: true, message: '企业状态不能为空', trigger: 'blur' }],
        enterpriseId: [
          { required: true, message: '企业名称不能为空', trigger: 'blur' }
        ],
        certificateType: [
          { required: true, message: '代码证类型不能为空', trigger: 'blur' }
        ],
        unitCategory: [
          { required: true, message: '单位类别不能为空', trigger: 'blur' }
        ],
        externalWorkerNumber: [{ required: true, message: '外用工人数不能为空', trigger: 'blur' }
        ],
        registerAddress: [
          { required: true, message: '注册地址不能为空', trigger: 'blur' }
        ],
        creditCode: [
          { required: true, message: '统一社会信用代码不能为空', trigger: 'blur' }
        ],
        businessAddress: [
          { required: true, message: '生产经营地址不能为空', trigger: 'blur' }
        ],
        businessLicenseCategory: [
          { required: true, message: '营业执照类别不能为空', trigger: 'blur' }
        ],
        legalRepresentative: [
          { required: true, message: '法定代表人不能为空', trigger: 'blur' }
        ],
        onDutyemployeeNumber: [{ required: true, message: '在岗工人数不能为空', trigger: 'blur' }],
        businessScope: [
          { required: true, message: '经营范围不能为空', trigger: 'blur' }
        ],
        industryCategory: [
          { required: true, message: '行业类别不能为空', trigger: 'blur' }
        ],
        registerValidity: [
          { required: true, message: '工商登记有效期不能为空', trigger: 'blur' }
        ],
        scale: [
          { required: true, message: '行业规模不能为空', trigger: 'blur' }
        ],
        economicType: [
          { required: true, message: '经济类型不能为空', trigger: 'blur' }
        ],
        registerCertificates: [
          { required: true, message: '注册证件上传不能为空', trigger: 'blur' }
        ],
        officeLocationGPSCoordinates: [
          { required: true, message: '办公地点GPS坐标不能为空', trigger: 'blur' }
        ]
      },
      rulesSafe: {
        parentName: [
          { required: true, message: '父级单位不能为空', trigger: 'blur' }
        ],
        safetyProductionMainResponsiblePerson: [
          { required: true, message: '安全生产主要负责人不能为空', trigger: 'blur' }
        ],
        employeeNumber: [
          { required: true, message: '从业人数不能为空', trigger: 'blur' }
        ],
        safetyProductionMainResponsiblePersonContactNumber: [
          { required: true, message: '安全生产主要负责人联系电话不能为空', trigger: 'blur' }
        ],
        registerSafeEngineerNumber: [
          { required: true, message: '注册安全工程师人数不能为空', trigger: 'blur' }
        ],
        inChargeOfSafety: [
          { required: true, message: '分管安全负责人不能为空', trigger: 'blur' }
        ],
        specialWorkNumber: [
          { required: true, message: '特种作业人数不能为空', trigger: 'blur' }
        ],
        inChargeOfSecurityResponsiblePersonTelephone: [
          { required: true, message: '分管安全负责人电话不能为空', trigger: 'blur' }
        ],
        productionState: [
          { required: true, message: '生产状态不能为空', trigger: 'blur' }
        ],
        safetyManagementPersonnel: [
          { required: true, message: '专职安全管理人员不能为空', trigger: 'blur' }
        ],
        safetyManagementPersonnelTelephone: [
          { required: true, message: '专职安全管理人员电话不能为空', trigger: 'blur' }
        ],
        RegistrationDocumentUpload: [
          { required: true, message: '许可证扫描件上传不能为空', trigger: 'blur' }
        ],
        unitOnDutyPhone: [
          { required: true, message: '单位值班电话不能为空', trigger: 'blur' }
        ],
        email: [
          { required: true, message: '电子邮箱不能为空', trigger: 'blur' }
        ]
      },
      locData: {
        ids: 0,
        lng: '',
        lat: ''
      },
      // 大地图固定死的显示
      projectGPSCoordinatesCenter: [
        [106.653298, 29.732213, '江西核工业工程地质勘察'],
        [115.807698, 28.662684, '江西核工业测绘院'],
        [116.412222, 39.912345, '江西省核工业地质局二六四大队'],
        [111.716982, 40.890667, '江西省核工业地质局二六六大队']
      ],
      projectGPSCoordinates: {
        lng: 0,
        lat: 0
      },
      pageEnterpriseLoading: true,
      pageSafeLoading: true,
      dialogImageUrl: '',
      registerCertificates: [],
      activeName: 'second',
      enterpriseOptions: [],
      dialogViewPics: false,
      btnLoading: false,
      editEnterpriseDialog: false,
      addEnterpriseDialog: false,
      editSafeDialog: false,
      addSafeDialog: false,
      // 引入百度地图默认倍数
      zoom: 11,
      /* 默认只要打开另一个就关闭之前的 */
      getRowKeys(row) {
        return row.id
      },
      expands: []
    }
  },
  created() {
    getEnterpriseOptions().then(res => {
      this.enterpriseOptions = res.data.obj
    })
    this.fetchSafeData()
    this.fetchData()
  },
  methods: {
    // 获取信息
    fetchData() {
      if (this.params.enterpriseIds.length !== 0) {
        this.params.enterpriseId = this.params.enterpriseIds[this.params.enterpriseIds.length - 1]
      }
      enterpriseBasicInfoList(this.params).then(res => {
        this.pageEnterpriseLoading = false
        this.page = res.data.obj
      })
    },
    fetchSafeData() {
      safeProductionInfoList(this.params).then(res => {
        this.pageSafeLoading = false
        this.pageSafe = res.data.obj
      })
    },
    editEnterpriseChangeData() {
      // 企业基本信息的修改
      if (this.editEnterpriseData.registerValidity === [] || this.editEnterpriseData.registerValidity[0] === null || this.editEnterpriseData.registerValidity[1] === null) {
        return
      }
      this.editEnterpriseData.registerValidityStartTime = this.editEnterpriseData.registerValidity[0]
      this.editEnterpriseData.registerValidityEndTime = this.editEnterpriseData.registerValidity[1]
    },
    addEnterpriseChangeData() {
      // 企业基本信息的修改
      if (this.addEnterpriseData.registerValidity === [] || this.addEnterpriseData.registerValidity[0] === null || this.addEnterpriseData.registerValidity[1] === null) {
        return
      }
      this.addEnterpriseData.registerValidityStartTime = this.addEnterpriseData.registerValidity[0]
      this.addEnterpriseData.registerValidityEndTime = this.addEnterpriseData.registerValidity[1]
    },
    editSafeChangeData() {
      if (this.editSafeData.productionLicenseValidity === [] || this.editSafeData.productionLicenseValidity[0] === null || this.editSafeData.productionLicenseValidity[1] === null) {
        return
      }
      this.editSafeData.productionLicenseValidityStartTime = this.editSafeData.productionLicenseValidity[0]
      console.log(this.editSafeData.productionLicenseValidityStartTime)
      this.editSafeData.productionLicenseValidityEndTime = this.editSafeData.productionLicenseValidity[1]
      console.log(this.editSafeData.productionLicenseValidityEndTime)
      if (this.editSafeData.registerValidity === [] || this.editSafeData.registerValidity[0] === null || this.editSafeData.registerValidity[1] === null) {
        return
      }
      this.editSafeData.registerValidityStartTime = this.editSafeData.registerValidity[0]
      this.editSafeData.registerValidityEndTime = this.editSafeData.registerValidity[1]
    },
    addSafeChangeData() {
      if (this.addSafeData.productionLicenseValidity === [] || this.addSafeData.productionLicenseValidity[0] === null || this.addSafeData.productionLicenseValidity[1] === null) {
        return
      }
      this.addSafeData.productionLicenseValidityStartTime = this.addSafeData.productionLicenseValidity[0]
      this.addSafeData.productionLicenseValidityEndTime = this.addSafeData.productionLicenseValidity[1]
      if (this.addSafeData.registerValidity === [] || this.addSafeData.registerValidity[0] === null || this.addSafeData.registerValidity[1] === null) {
        return
      }
      this.addSafeData.registerValidityStartTime = this.addSafeData.registerValidity[0]
      this.addSafeData.registerValidityEndTime = this.addSafeData.registerValidity[1]
    },
    // 设置当前对象所在的下标，用于点击详情前获取数组中该对象的经纬度
    setCurrentIndex(index) {
      if (this.page.list.length === 0) {
        return
      }
      this.page.list[index].index = index
    },
    // 折叠面板每次只能展开一行
    expandSelect(row, expandedRows) {
      var that = this
      if (expandedRows.length) {
        that.expands = []
        if (row) {
          this.projectGPSCoordinates.lng = row.gpsLng
          this.projectGPSCoordinates.lat = row.gpsLat
          // 打开当前点击的 详情
          that.expands.push(row.id)// 每次push进去的是每行的ID
        }
      } else {
        that.expands = []// 默认不展开
      }
    },
    handleEditEnterpriseChange(value) {
      if (value !== null || value !== []) {
        this.editEnterpriseData.enterpriseId = value[value.length - 1]
      }
    },
    handleAddEnterpriseChange(value) {
      if (value !== null || value !== []) {
        this.addEnterpriseData.enterpriseId = value[value.length - 1]
        this.addEnterpriseData.parentName = this.getParentName(value)
      }
    },
    handleEditSafeChange(value) {
      if (value !== null || value !== []) {
        this.editSafeData.enterpriseId = value[value.length - 1]
      }
    },
    handleAddSafeChange(value) {
      if (value !== null || value !== []) {
        this.addSafeData.enterpriseId = value[value.length - 1]
        this.addSafeData.parentName = this.getParentName(value)
      }
    },
    // 获取父级单位名称
    getParentName(enterpriseIds) {
      var parentName = null
      try {
        if (enterpriseIds.length === 2) {
          this.enterpriseOptions.forEach(e => {
            e.children.forEach(ce => {
              if (ce.value === enterpriseIds[1]) {
                parentName = e.label
                throw new Error(parentName)
              }
            })
          })
        }
      } catch (e) {
        console.log(e.message)
      }
      return parentName
    },
    // 详情里面的小地图
    smallEnterpriseMap({ BMap, map }) {
      var point = new BMap.Point(this.projectGPSCoordinates.lng, this.projectGPSCoordinates.lat) // 初始化地图,设置中心点坐标和地图级别
      map.centerAndZoom(point, this.zoom)
      var marker = new BMap.Marker(point) // 创建标注
      map.addOverlay(marker) // 将标注添加到地图中
      /* var circle = new BMap.Circle(point, 6, {
        strokeColor: 'Red',
        strokeWeight: 6,
        strokeOpacity: 1,
        Color: 'Red',
        fillColor: '#f03'
      })
      // 将标注添加到地图中,底下的小圆点
      map.addOverlay(circle) */
    },
    // 页面底下的地图
    bigEnterpriseMap({ BMap, map }) {
      map.centerAndZoom(new BMap.Point(104.769128, 34.972443), 5)
      var data_info = this.projectGPSCoordinatesCenter
      var opts = {
        width: 250, // 信息窗口宽度
        height: 60, // 信息窗口高度
        title: '信息窗口', // 信息窗口标题
        enableMessage: true // 设置允许信息窗发送短息
      }
      for (var i = 0; i < data_info.length; i++) {
        var marker = new BMap.Marker(
          new BMap.Point(data_info[i][0], data_info[i][1])
        )
        // 创建标注
        var content = data_info[i][2]
        map.addOverlay(marker)
        var label = new BMap.Label(data_info[i][2], { offset: new BMap.Size(GLOBAL.BMAP_LABEL_OFFSET.width, GLOBAL.BMAP_LABEL_OFFSET.height) })
        marker.setLabel(label)
        // 将标注添加到地图中
        addClickHandler(content, marker)
      }
      function addClickHandler(content, marker) {
        marker.addEventListener('click', function(e) {
          openInfo(content, e)
        })
      }
      function openInfo(content, e) {
        var p = e.target
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat)
        var infoWindow = new BMap.InfoWindow(content, opts) // 创建信息窗口对象
        map.openInfoWindow(infoWindow, point) // 开启信息窗口
      }
    },
    // 点击添加修改 弹窗里面的小地图，添加默认根据ip来定位
    editEnterpriseDialogMap({ BMap, map }) {
      window.map = map // 将map变量存储在全局
      var point = new BMap.Point(this.locData.lng, this.locData.lat) // 初始化地图,设置中心点坐标和地图级别
      map.centerAndZoom(point, this.zoom)
      var marker = new BMap.Marker(point) // 创建标注
      map.addOverlay(marker) // 将标注添加到地图中
    },
    addEnterpriseDialogMap({ BMap, map }) {
      window.map = map // 将map变量存储在全局
      var point = new BMap.Point(116.331398, 39.897445)
      map.centerAndZoom(point, this.zoom)
      function myFun(result) {
        var cityName = result.name
        map.setCenter(cityName)
      }
      var myCity = new BMap.LocalCity()
      myCity.get(myFun)
    },
    // 点击添加和修改里面的弹窗-点击获取地点
    getAddEnterpriseClickInfoMap(e) {
      // 清除所要清除的覆盖物
      map.clearOverlays()
      var myMarker = new BMap.Marker(new BMap.Point(e.point.lng, e.point.lat))
      map.addOverlay(myMarker)
      this.locData.lng = e.point.lng
      this.locData.lat = e.point.lat
    },
    getEditEnterpriseClickInfoMap(e) {
      // 清除所要清除的覆盖物
      map.clearOverlays()
      var myMarker = new BMap.Marker(new BMap.Point(e.point.lng, e.point.lat))
      map.addOverlay(myMarker)
      this.locData.lng = e.point.lng
      this.locData.lat = e.point.lat
    },
    // 关闭按钮
    handleClose(done) {
      this.$confirm('确认关闭？')
        .then(_ => {
          done()
        })
        .catch(_ => {})
    },
    // 安全生产信息
    editOpenSafeDialog(index, row) {
      this.editSafeDialog = true // 编辑信息模态框显示
      // 获得所有数据显示在编辑信息模态框里面;
      this.editSafeData = Object.assign({}, row)
    },
    // 企业基本信息-增删改
    submitEnterpriseAddForm(formName) {
      this.addEnterpriseData.gpsLng = this.locData.lng
      this.addEnterpriseData.gpsLat = this.locData.lat
      this.$refs[formName].validate(valid => {
        if (!this.addEnterpriseData.gpsLng || !this.addEnterpriseData.gpsLat) {
          this.$message.error('请选择办公地点坐标')
          return
        }
        if (!this.addEnterpriseData.enterpriseIds) {
          this.$message.error('请选择企业名称')
          return
        }
        if (valid) {
          this.btnLoading = false
          enterpriseBasicInfoAdd(this.addEnterpriseData).then(res => {
            if (res.data.status === 200) {
              this.$message.success('添加成功!')
              this.fetchData()
              this.addEnterpriseDialog = false
            } else {
              this.$message.error('添加失败，请重试联系管理员!')
            }
          }).catch(() => {
            this.$message.error('添加失败!')
          })
        }
      })
    },
    submitEnterpriseEditForm(formName) {
      this.editEnterpriseData.gpsLng = this.locData.lng
      this.editEnterpriseData.gpsLat = this.locData.lat
      this.$refs[formName].validate(valid => {
        if (valid) {
          this.btnLoading = false
          enterpriseBasicInfoUpdate(this.editEnterpriseData).then(res => {
            if (res.data.status === 200) {
              this.$message.success('修改成功!')
              this.fetchData()
              this.editEnterpriseDialog = false
            } else {
              this.$message.error('修改失败，请重试联系管理员!')
            }
          }).catch(() => {
            this.$message.error('修改失败!')
          })
        }
      })
    },
    delEnterprise(index, row) {
      this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      })
        .then(() => {
          enterpriseBasicInfoDelete(Object.assign({}, row).id).then(res => {
            this.page.list.splice(index, 1)
            this.fetchData()
            this.$message({
              type: 'success',
              message: '删除成功!'
            })
          })
        })
    },
    editOpenEnterpriseDialog(index, row) {
      // 获得所有数据显示在编辑信息模态框里面;
      this.editEnterpriseData = Object.assign({}, row)
      this.projectGPSCoordinates.lng = this.editEnterpriseData.gpsLng
      this.projectGPSCoordinates.lat = this.editEnterpriseData.gpsLat
      this.locData = this.projectGPSCoordinates
      this.editEnterpriseData.registerValidity = [this.editEnterpriseData.registerValidityStartTime, this.editEnterpriseData.registerValidityEndTime]
      this.editEnterpriseData.fileIds = []
      const urlPre = process.env.VUE_APP_BASE_API
      this.editEnterpriseData.registerCertificates.forEach((e, index) => {
        this.editEnterpriseData.fileIds.push(e.fileId)
        e.url = urlPre + e.url
      })
      this.editEnterpriseData.enterpriseIds = this.editEnterpriseData.enterpriseType === 'D' ? [this.editEnterpriseData.enterpriseId] : [this.editEnterpriseData.parentId, this.editEnterpriseData.enterpriseId]
      this.editEnterpriseDialog = true // 编辑信息模态框显示
    },
    // 企业基本信息分页
    handleSizeChangeEnterprise(val) {
      console.log(`每页 ${val} 条`)
      this.params.size = val
      this.fetchSafeData()
    },
    handleCurrentChangeEnterprise(val) {
      console.log(`当前页: ${val}`)
      this.params.page = val
      this.fetchSafeData()
    },
    handleSizeChangeSafe(val) {
      console.log(`每页 ${val} 条`)
      this.params.sizeSafe = val
      this.fetchData()
    },
    handleCurrentChangeSafe(val) {
      console.log(`当前页: ${val}`)
      this.params.pageSafe = val
      this.fetchData()
    },
    // 图片管理
    handleEditSuccess(response, file, registerCertificates) {
      this.editEnterpriseData.registerCertificates = registerCertificates
      this.editEnterpriseData.fileIds.push(response.obj.fileId)
      // this.dailyLoading = false
    },
    handleAddSuccess(response, file, registerCertificates) {
      this.addEnterpriseData.fileIds.push(response.obj.fileId)
      this.addEnterpriseData.registerCertificates = registerCertificates
    },
    handleEditRemove(file, registerCertificates) {
      // 如果文件是未上传成功的直接删除就可以了，不需要执行下面的操作
      if (file.status !== 'success') {
        this.editEnterpriseData.registerCertificates = registerCertificates
        return
      }
      // 当前删除文件的 fileId，然后在fileIds里找到来删除即可3
      var delFileId = null
      for (const i in this.editEnterpriseData.registerCertificates) {
        console.log(i)
        if (this.editEnterpriseData.registerCertificates[i].uid === file.uid) {
          if (this.editEnterpriseData.registerCertificates[i].response !== undefined) {
          // 新上传的文件
            delFileId = this.editEnterpriseData.registerCertificates[i].response.obj.fileId
            break
          } else {
          // 原有的文件
            delFileId = this.editEnterpriseData.registerCertificates[i].fileId
            break
          }
        }
      }
      this.editEnterpriseData.registerCertificates = registerCertificates
      this.editEnterpriseData.fileIds.forEach((e, index) => {
        console.log(this.editEnterpriseData.fileIds)
        if (e === delFileId) {
          this.editEnterpriseData.fileIds.splice(index, 1)
          return
        }
      })
    },
    handleAddRemove(file, registerCertificates) {
      this.addEnterpriseData.registerCertificates = registerCertificates
    },
    handleSafeEditRemove(file, registerCertificates) {
    },
    handleSafeAddRemove(file, registerCertificates) {
    },
    handlePictureCardPreview(file) {
      this.dialogImageUrl = file.url
      this.viewPics([file])
    },
    // 图片格式
    beforeAvatarUpload(file) {
      const isJPG = file.type === 'image/jpeg'
      const isPng = file.type === 'image/png'
      const isLt2M = file.size / 1024 / 1024 < 2
      if (!isJPG && !isPng) {
        this.$message.error('上传图片只能是 JPG或png 格式!')
      }
      if (!isLt2M) {
        this.$message.error('上传图片大小不能超过 2MB!')
      }
      return (isJPG || isPng) && isLt2M
    },
    // 查看照片
    viewPics(registerCertificates) {
      this.dialogViewPics = true
      this.registerCertificates = registerCertificates
    },
    /* 显示图片出错时 */
    handleLoadError(e) {
      const img = e.srcElement
      this.imageUrl = this.errorLoadImg //  用加载失败的图片替代之
      img.onerror = null //  清除错误:如果错误时加载时显示的图片出错，将会一直循环，所以我们必须清除掉错误，限制运行一次
    }
  }
}
</script>

<style lang="scss" scoped>
.dashboard {
  &-container {
    margin: 30px;
  }
  &-text {
    font-size: 30px;
    line-height: 46px;
  }
}
.colBorder2{
  background-color: #F6F6F8;
}
.el-form-item--mini.el-form-item, .el-form-item--small.el-form-item{
  margin-bottom: 0;
  margin:10px;
}
.el-row{
 margin-bottom: 0;
}
</style>
